'use strict';const a6=b,a8=b;(function(c,d){const a4=b,a5=b,e=c();while(!![]){try{const f=parseInt(a4(0x134))/0x1+-parseInt(a5(0x182))/0x2*(-parseInt(a5(0x185))/0x3)+-parseInt(a4(0x121))/0x4+parseInt(a4(0x15a))/0x5+parseInt(a5(0x144))/0x6+parseInt(a5(0x136))/0x7*(-parseInt(a5(0x12a))/0x8)+-parseInt(a4(0x124))/0x9*(parseInt(a4(0x130))/0xa);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x7f7bc));var __importDefault=this&&this[a6(0x12d)]||function(c){const a7=a6;return c&&c[a7(0x15d)]?c:{'default':c};};Object[a8(0x12f)](exports,a8(0x15d),{'value':!![]});const lodash_1=require('lodash'),Utils_1=require('./Utils'),Index_1=require('./Index'),User_1=__importDefault(require(a8(0x123))),logger_1=require(a6(0x163)),events={},JoinChatServer=c=>{const a9=a8,aa=a6,{user:d}=c['handshake'][a9(0x15c)];logger_1[aa(0x138)][aa(0x14c)](a9(0x168)+d[aa(0x152)]);const {tenantId:e}=d,f=a9(0x13e)+e;let g;g=Index_1[aa(0x132)][f];g&&(g['usersOnline'][d['id']]={'sockets':[c['id']],'user':d},g[aa(0x160)][aa(0x153)](c),(0x0,Utils_1[a9(0x137)])(c,a9(0x140)));if(!g){if('aFmMU'!=='SsfBb')Index_1[aa(0x132)][f]={'sockets':[],'usersOnline':{},'idleUsers':{}},g=Index_1[a9(0x132)][f],g['usersOnline'][d['id']]={'sockets':[c['id']],'user':d},g[aa(0x160)]['push'](c),(0x0,Utils_1[aa(0x137)])(c,d['tenantId']+aa(0x146));else{const {user:i}=g['handshake'][a9(0x15c)],j=h[aa(0x13a)][a9(0x148)](i['id']);(0x0,i[aa(0x137)])(j,aa(0x14d),j);}}},UpdateUsers=c=>{const ab=a8,ac=a8,{user:d}=c[ab(0x156)][ab(0x15c)],e=ac(0x13e)+d[ab(0x176)],f=Index_1[ac(0x132)][e],g=(0x0,Utils_1['sortByKeys'])(f[ac(0x164)]);(0x0,lodash_1['forEach'])(g,h=>{const ad=ab,i=h['user'],{sockets:j}=h;i&&j['length']>0x0&&(0x0,lodash_1[ad(0x120)])(j,k=>{const ae=ad,af=ad,l=(0x0,lodash_1[ae(0x165)])(f[ae(0x160)],m=>{return m['id']===k;});if(l){if(ae(0x17b)===ae(0x17b))(i['role'][ae(0x15f)]||i[ae(0x125)][af(0x13d)])&&l[ae(0x17a)](ae(0x131),g);else{let n=q[ae(0x132)][r];n?.[af(0x142)][s['id']]&&delete n?.[af(0x142)][E['id']],!n&&(F[af(0x132)][G]={'sockets':[],'usersOnline':{},'idleUsers':{}},n=H[af(0x132)][I],n[ae(0x164)][af(0x153)](J['id'])),n?.['usersOnline']&&(n['usersOnline'][K['id']]={'sockets':[L['id']],'user':M}),C(D);}}});});},UpdateOnlineBubbles=c=>{const ag=a6,ah=a8,{user:d}=c[ag(0x156)]['auth'],e='socketData_'+d[ah(0x176)],f=Index_1['shared'][e],g=(0x0,lodash_1[ah(0x143)])((0x0,lodash_1[ag(0x11f)])((0x0,lodash_1['toPairs'])(f[ah(0x164)]),i=>{const ai=ag,aj=ag;if(ai(0x133)===aj(0x17c))h['idleUsers'][i['id']][aj(0x160)]=(0x0,j[aj(0x16d)])(k,l['id']);else return i[0x0];})),h=(0x0,lodash_1['fromPairs'])((0x0,lodash_1[ah(0x11f)])((0x0,lodash_1['toPairs'])(f[ag(0x142)]),i=>{const ak=ah,al=ag;if(ak(0x174)!==al(0x159))return i[0x0];else{const k=l[ak(0x164)][m['id']][ak(0x160)];(0x0,n[al(0x177)])(k)<0x2?delete u[ak(0x164)][v['id']]:w[ak(0x164)][x['id']][ak(0x160)]=(0x0,y[ak(0x16d)])(k,z['id']);}}));(0x0,Utils_1[ah(0x128)])(c,d[ah(0x176)]+ah(0x12e),{'sortedUserList':g,'sortedIdleList':h});},SpawnOpenChatWindows=c=>{const am=a6,an=a8,{user:d}=c[am(0x156)][am(0x15c)],e=User_1[an(0x13a)][an(0x148)](d['id']);(0x0,Utils_1[an(0x137)])(c,an(0x14d),e);},spawnChatWindow=c=>{c['on']('spawnChatWindow',async d=>{const ao=b,ap=b,e=await User_1[ao(0x13a)]['findByPk'](d,{'attributes':['id',ap(0x152),'email','profile']});(0x0,Utils_1[ao(0x137)])(c,ao(0x14d),e);});},onSetUserIdle=c=>{const aq=a6,ar=a8,{user:d}=c['handshake'][aq(0x15c)],e=ar(0x13e)+d[aq(0x176)];c['on'](d[aq(0x176)]+ar(0x17e),()=>{const as=ar,at=aq;let f;f=Index_1[as(0x132)][e];f&&(f[at(0x142)][d['id']]={'sockets':[c['id']],'user':d});if(!f){if(at(0x141)!==as(0x161))Index_1['shared'][e]={'sockets':[],'usersOnline':{},'idleUsers':{}},f=Index_1[at(0x132)][e],f[at(0x142)][as(0x153)](c['id']);else{const h=t[at(0x132)][u];if(h){const {to:i}=K,{from:j}=L;M[at(0x14f)]('TO',i),N[at(0x14f)](as(0x135),j);const k=O['type'];P[at(0x170)]==='s'?Z[at(0x170)]='r':a0[as(0x170)]='s',(0x0,S[at(0x12c)])(h[at(0x160)],h[as(0x164)],T['toUser'][as(0x179)],as(0x13c),U),V[at(0x170)]=k,(0x0,W[at(0x12c)])(h['sockets'],h['usersOnline'],X['fromUser'][at(0x179)],at(0x13c),Y);}}}if(f?.[at(0x164)][d['id']]){if(as(0x172)!==as(0x172))return d[0x0];else delete f?.[at(0x164)][d['id']];}UpdateOnlineBubbles(c);});},onSetUserActive=c=>{const au=a8,av=a8,{user:d}=c['handshake'][au(0x15c)],e=av(0x13e)+d[av(0x176)];c['on'](d[av(0x176)]+':setUserActive',()=>{const aw=av,ax=av;if(aw(0x17d)===aw(0x17d)){let f=Index_1[ax(0x132)][e];f?.['idleUsers'][d['id']]&&delete f?.[ax(0x142)][d['id']],!f&&(Index_1['shared'][e]={'sockets':[],'usersOnline':{},'idleUsers':{}},f=Index_1[ax(0x132)][e],f[ax(0x164)][aw(0x153)](c['id'])),f?.[aw(0x164)]&&(f[ax(0x164)][d['id']]={'sockets':[c['id']],'user':d}),UpdateOnlineBubbles(c);}else j[aw(0x132)][k]={'sockets':[],'usersOnline':{},'idleUsers':{}},l=m[aw(0x132)][n],o['usersOnline'][ax(0x153)](p['id']);});},onUpdateUsers=c=>{const ay=a8;c['on'](ay(0x131),UpdateUsers);},onChatMessage=c=>{const az=a8,aA=a6,{user:d}=c[az(0x156)][az(0x15c)],{tenantId:e}=d,f=aA(0x13e)+e;c['on'](aA(0x13c),function(g){const aB=aA,aC=az,h=Index_1[aB(0x132)][f];if(h){if(aB(0x166)!=='cBget'){const {to:i}=g,{from:j}=g;console[aC(0x14f)]('TO',i),console[aB(0x14f)]('FROM',j);const k=g[aB(0x170)];g[aB(0x170)]==='s'?g[aB(0x170)]='r':g[aC(0x170)]='s',(0x0,Utils_1[aC(0x12c)])(h[aB(0x160)],h[aB(0x164)],g['toUser'][aC(0x179)],aB(0x13c),g),g['type']=k,(0x0,Utils_1['sendToUser'])(h['sockets'],h[aC(0x164)],g[aC(0x16e)][aC(0x179)],aC(0x13c),g);}else return;}});},onChatTyping=c=>{const aD=a6,aE=a8,{user:d}=c['handshake'][aD(0x15c)],{tenantId:e}=d,f=aE(0x13e)+e;c['on']('chatTyping',g=>{const aF=aD,aG=aE;if('zfYsg'===aF(0x167))g[aG(0x142)][h['id']]={'sockets':[i['id']],'user':j};else{const i=Index_1['shared'][f];if(i){if(aF(0x171)===aG(0x171)){const {to:j}=g,{from:k}=g;let l=null,m=null;(0x0,lodash_1[aF(0x165)])(i['usersOnline'],function(n){const aH=aG,aI=aF;String(n[aH(0x127)]['id'])===String(j)&&(aH(0x129)===aH(0x145)?d[aI(0x170)]='r':l=n[aH(0x127)]),String(n['user']['id'])===String(k)&&(aI(0x151)===aH(0x183)?delete e[aH(0x164)][f['id']]:m=n[aI(0x127)]);});if((0x0,lodash_1[aG(0x150)])(l)||(0x0,lodash_1[aF(0x150)])(m))return;g['toUser']=l,g[aG(0x16e)]=m,(0x0,Utils_1[aF(0x12c)])(i[aG(0x160)],i['usersOnline'],l[aG(0x152)],aG(0x16c),g);}else e['on'](aG(0x131),f);}}});},onChatStopTyping=c=>{const aJ=a6,aK=a6,{user:d}=c[aJ(0x156)][aJ(0x15c)],{tenantId:e}=d,f=aJ(0x13e)+e;c['on'](aJ(0x14a),g=>{const aL=aJ,aO=aK,h=Index_1['shared'][f];if(h){const {to:i}=g;let j=null;(0x0,lodash_1[aL(0x165)])(h['usersOnline'],k=>{const aM=aL,aN=aL;String(k[aM(0x127)]['id'])===String(i)&&(j=k[aN(0x127)]);});if((0x0,lodash_1[aL(0x150)])(j)){if('wNdlJ'!==aL(0x16a))return;else delete e?.['idleUsers'][f['id']];}g['toUser']=j,(0x0,Utils_1[aO(0x12c)])(h['sockets'],h['usersOnline'],j[aL(0x152)],'chatStopTyping',g);}});},saveChatWindow=c=>{c['on']('saveChatWindow',async d=>{const aP=b,aQ=b,{userId:e}=d,{remove:f}=d,g=await User_1[aP(0x13a)][aP(0x148)](e);if(g){if(aP(0x178)===aP(0x15b))f['on'](aQ(0x149),()=>{i(j);});else{if(f){}else{}}}});},onDisconnect=c=>{const aR=a6;c['on'](aR(0x158),async d=>{const aS=aR,aT=aR,{user:e}=c[aS(0x156)][aT(0x15c)],{tenantId:f}=e,g=aT(0x13e)+f,h=Index_1[aS(0x132)][g];if(h?.[aT(0x164)]){if(h[aT(0x164)][e['id']]){const l=h[aT(0x164)][e['id']][aS(0x160)];(0x0,lodash_1[aT(0x177)])(l)<0x2?aS(0x126)==='WLKGp'?delete h[aT(0x164)][e['id']]:e=f['user']:h['usersOnline'][e['id']]['sockets']=(0x0,lodash_1[aT(0x16d)])(l,c['id']);}const k=(0x0,lodash_1[aT(0x173)])(h[aT(0x160)],{'id':c['id']});h[aT(0x160)]=(0x0,lodash_1[aS(0x16d)])(h['sockets'],k);}if(h?.[aT(0x142)]){if(h['idleUsers'][e['id']]){if(aS(0x154)===aS(0x162)){const q=l['idleUsers'][m['id']]['sockets'];(0x0,n[aS(0x177)])(q)<0x2?delete u[aT(0x142)][v['id']]:w[aS(0x142)][x['id']][aT(0x160)]=(0x0,y[aT(0x16d)])(q,z['id']);}else{const q=h['idleUsers'][e['id']][aS(0x160)];if((0x0,lodash_1['size'])(q)<0x2){if('WASIJ'!=='WASIJ'){const {user:s}=m[aT(0x156)]['auth'],t=aT(0x13e)+s[aT(0x176)],u=n[aS(0x132)][t],v=(0x0,o[aS(0x143)])((0x0,p[aS(0x11f)])((0x0,q[aT(0x16f)])(u['usersOnline']),B=>{return B[0x0];})),A=(0x0,r[aT(0x143)])((0x0,s['sortBy'])((0x0,t[aT(0x16f)])(u[aS(0x142)]),B=>{return B[0x0];}));(0x0,u[aT(0x128)])(v,s[aS(0x176)]+aS(0x12e),{'sortedUserList':v,'sortedIdleList':A});}else delete h[aS(0x142)][e['id']];}else h['idleUsers'][e['id']][aS(0x160)]=(0x0,lodash_1[aT(0x16d)])(q,c['id']);}}const n=(0x0,lodash_1['findKey'])(h[aT(0x160)],{'id':c['id']});h[aT(0x160)]=(0x0,lodash_1[aT(0x16d)])(h['sockets'],n);}const j=await User_1['default'][aS(0x148)](e['id']);j?.['update']({'status':aT(0x122),'lastOnline':new Date()}),UpdateOnlineBubbles(c),d==='transport\x20error'&&(d=aS(0x181)),logger_1['logger'][aS(0x180)](aS(0x12b)+d+'):\x20'+e[aS(0x152)]+aS(0x15e)+c['id']);});};function a(){const b1=['607636KlidXH','pGcPs','onDisconnect','6IdtmWX','sortBy','forEach','912700ccEYRv','offline','../../models/User','63iBOroE','role','WLKGp','user','sendToAllConnectedClients','cYWJH','112816tQkkGt','User\x20disconnected\x20(','sendToUser','__importDefault',':chat:updateOnlineBubbles','defineProperty','1262290jEsofv','updateUsers','shared','OyXah','235937miWgAu','FROM','42gtPOCt','sendToSelf','logger','onChatMessage','default','onChatStopTyping','chatMessage','isAgent','socketData_','onSetUserActive','joinSuccessfully','wLLgP','idleUsers','fromPairs','3948396uCBOMw','ToilC',':joinSuccessfully','Klynx','findByPk','getOpenChatWindows','chatStopTyping','onChatTyping','info','spawnChatWindow','saveChatWindow','log','isNull','LjoyQ','name','push','GNCnY','XJUof','handshake','onSetUserIdle','disconnect','zoozT','1084615cCWubw','oiCWG','auth','__esModule','\x20-\x20','isAdmin','sockets','TRIyl','XDjnH','../../utils/logger','usersOnline','find','UbBpj','SDFIn','joinChatServer\x20USER\x20','lRLcY','BhuIl','updateOnlineBubbles','chatTyping','without','fromUser','toPairs','type','pWwyz','qbwKE','findKey','PoOpQ','BBQKL','tenantId','size','dSCMp','username','emit','TzEBF','yDfzx','nIbCA',':setUserIdle','onUpdateUsers','debug','client\x20terminated'];a=function(){return b1;};return a();}events['onSetUserIdle']=onSetUserIdle,events[a6(0x13f)]=onSetUserActive,events[a8(0x17f)]=onUpdateUsers,events[a8(0x14d)]=spawnChatWindow,events[a6(0x139)]=onChatMessage,events['onChatTyping']=onChatTyping,events['onChatStopTyping']=onChatStopTyping,events['saveChatWindow']=saveChatWindow,events[a6(0x184)]=onDisconnect,events[a6(0x16b)]=c=>{const aU=a6,aV=a8,{user:d}=c[aU(0x156)][aV(0x15c)];c['on'](d['tenantId']+aU(0x12e),()=>{const aW=aU,aX=aU;aW(0x155)!==aW(0x155)?e['emit'](aW(0x131),f):UpdateOnlineBubbles(d[aX(0x176)]);});},events[a6(0x149)]=c=>{const aY=a6;c['on'](aY(0x149),()=>{SpawnOpenChatWindows(c);});};function b(c,d){const e=a();return b=function(f,g){f=f-0x11f;let h=e[f];return h;},b(c,d);}function register(c){const aZ=a8,b0=a6;if(!c[aZ(0x156)]?.[b0(0x15c)]?.[b0(0x176)]){if(aZ(0x147)!==aZ(0x169))return;else delete e?.[aZ(0x164)][f['id']];}events[aZ(0x157)](c),events[aZ(0x13f)](c),events[b0(0x17f)](c),events[b0(0x16b)](c),events[b0(0x14d)](c),events[aZ(0x149)](c),events['onChatMessage'](c),events[b0(0x14b)](c),events[b0(0x13b)](c),events[b0(0x14e)](c),events[b0(0x184)](c),c[aZ(0x156)]['auth'][b0(0x127)]['id']&&(b0(0x175)!=='eFVvy'?JoinChatServer(c):e=f[b0(0x127)]);}const eventLoop=c=>{UpdateUsers(c),UpdateOnlineBubbles(c);},chat={'events':events,'eventLoop':eventLoop,'register':register};exports[a6(0x13a)]=chat;