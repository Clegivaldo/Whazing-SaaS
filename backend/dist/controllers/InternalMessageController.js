'use strict';const z=b,A=b;(function(c,d){const w=b,x=b,e=c();while(!![]){try{const f=parseInt(w(0x1d9))/0x1+-parseInt(w(0x1ca))/0x2*(-parseInt(x(0x1a5))/0x3)+-parseInt(x(0x1c0))/0x4*(-parseInt(x(0x1bf))/0x5)+-parseInt(x(0x1c1))/0x6+-parseInt(w(0x1d8))/0x7+parseInt(w(0x1a3))/0x8+-parseInt(x(0x1b0))/0x9*(-parseInt(x(0x1bd))/0xa);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xd6a13));function b(c,d){const e=a();return b=function(f,g){f=f-0x1a2;let h=e[f];return h;},b(c,d);}function a(){const L=['Mensagems\x20marcadas\x20como\x20lida.','../services/InternalMessage/ReadMessageService','afNGu','YNvWA','5804029izwGnB','79131TIKPko','receiver','error','tfGPT','true','../services/InternalMessage/ListCountUnreadMessage','listarMensagens','mediaType','getIO','../services/InternalMessage/MessageService','json','originalname','mimetype','user','8928960dFiSDT','indexOf','4551UmupIB','Ocorreu\x20um\x20erro\x20ao\x20marcar\x20a\x20mensagens\x20como\x20lida.','findOne','../utils/logger','files','emit','marcarMensagemNaoLida','receiverId','params','status','name','2156481UtWWlW','findByPk','criarMensagem',':unread-mensagem-chat-interno','__esModule','filename','Ocorreu\x20um\x20erro\x20ao\x20criar\x20a\x20mensagem.','getTime','aIGPE','mediaName','tpCTx','xoJQI','qZMAd','10VwXkpO','all','5KhhJys','1298688gzkdBn','6396810WWJpTp','query','listCountUnreadMessage','map','default','split','CaQcY','body','timestamp','1338PbnYXM','update','groupId','mediaUrl','sender','Ocorreu\x20um\x20erro\x20ao\x20contar\x20as\x20mensagens\x20nÃ£o\x20lidas.','defineProperty','Ocorreu\x20um\x20erro\x20ao\x20listar\x20as\x20mensagens.','chat','ERR_CREATING_MESSAGE_SYSTEM'];a=function(){return L;};return a();}var __importDefault=this&&this['__importDefault']||function(c){const y=b;return c&&c[y(0x1b4)]?c:{'default':c};};Object[z(0x1d0)](exports,'__esModule',{'value':!![]}),exports[A(0x1c3)]=exports['marcarMensagemNaoLida']=exports['criarMensagem']=exports[A(0x1df)]=void 0x0;const socket_1=require('../libs/socket'),InternalMessage_1=__importDefault(require('../models/InternalMessage')),User_1=__importDefault(require('../models/User')),ListCountUnreadMessage_1=__importDefault(require(A(0x1de))),MessageService_1=__importDefault(require(A(0x1e2))),ReadMessageService_1=__importDefault(require(A(0x1d5))),logger_1=require(z(0x1a8)),listarMensagens=async(c,d)=>{const B=z,C=z;try{const {id:e}=c[B(0x1a2)],{userId:f}=c['params'],{isGroup:g}=c[B(0x1c2)],h=await MessageService_1[C(0x1c5)]['listarMensagens'](e,f,g);return d[B(0x1ae)](0xc8)[C(0x1e3)]({'mensagens':h});}catch(i){if(C(0x1d7)!==B(0x1bb))return console[C(0x1db)](i),d[B(0x1ae)](0x1f4)['json']({'error':'Ocorreu\x20um\x20erro\x20ao\x20listar\x20as\x20mensagens.'});else{const k=f[C(0x1e5)][C(0x1c6)]('/')[0x1]['split'](';')[0x0];g['filename']=new h()['getTime']()+'.'+k;}}};exports[A(0x1df)]=listarMensagens;const criarMensagem=async(c,d)=>{const D=z,E=z;try{const {text:e,timestamp:f,receiverId:g,isGroup:h}=c[D(0x1c8)],{id:i,tenantId:j}=c[D(0x1a2)],k=c[D(0x1a9)],l=(0x0,socket_1[E(0x1e1)])(),m={'text':e,'timestamp':f,'receiverId':g,'senderId':i,'tenantId':j,'groupId':null,'mediaType':E(0x1d2),'mediaUrl':undefined,'createdAt':new Date(),'updatedAt':new Date()};(h===!![]||h===D(0x1dd))&&(m['receiverId']=undefined,m[D(0x1cc)]=g);let n={};if(k&&k['length']>0x0)await Promise[E(0x1be)](k[D(0x1c4)](async p=>{const F=D,G=D;try{if(F(0x1d6)==='afNGu'){if(!p[F(0x1b5)]){if(G(0x1dc)===F(0x1ba))g['receiverId']=h,i[G(0x1cc)]=j;else{const t=p['mimetype']['split']('/')[0x1][F(0x1c6)](';')[0x0];p['filename']=new Date()[F(0x1b7)]()+'.'+t;}}}else return f[G(0x1db)](g),h['status'](0x1f4)['json']({'error':F(0x1b6)});}catch(v){logger_1['logger'][G(0x1db)](v);}const q={...m,'text':p[F(0x1e4)],'mediaUrl':p[G(0x1b5)],'mediaType':p[G(0x1e0)]||p['mimetype']['substr'](0x0,p[G(0x1e5)][G(0x1a4)]('/'))},r=await MessageService_1[G(0x1c5)][G(0x1b2)](q);n=await InternalMessage_1[G(0x1c5)][F(0x1b1)](r['id']);if(!n)throw new Error(F(0x1d3));}));else{if(E(0x1bc)!==E(0x1c7))n=await MessageService_1['default'][E(0x1b2)](m);else return f[D(0x1db)](g),h[E(0x1ae)](0x1f4)['json']({'error':D(0x1d1)});}const o=await InternalMessage_1[E(0x1c5)][E(0x1a7)]({'where':{'id':n['id']},'include':[{'model':User_1[E(0x1c5)],'as':E(0x1ce),'attributes':['id','name']},{'model':User_1[E(0x1c5)],'as':'receiver','attributes':['id',E(0x1af)]}]});return l[D(0x1aa)](j+':mensagem-chat-interno',{'action':E(0x1cb),'data':{'id':o['id'],'receiverId':o[E(0x1ac)],'mediaType':o[D(0x1e0)],'mediaName':o[E(0x1b9)],'mediaUrl':o[E(0x1cd)],'senderId':i,'timestamp':o['timestamp'],'sender':o[D(0x1ce)],'groupId':o[E(0x1cc)],'receiver':o[E(0x1da)],'text':e}}),l[D(0x1aa)](j+':mensagem-chat-interno-notificacao',{'action':E(0x1cb),'data':{'id':o['id'],'receiverId':g,'senderId':i,'mediaType':o[E(0x1e0)],'timestamp':o[E(0x1c9)],'sender':o[E(0x1ce)],'groupId':o[E(0x1cc)],'receiver':o[E(0x1da)],'text':e}}),d[D(0x1ae)](0xc9)[D(0x1e3)]({'mensagem':o});}catch(q){return console[D(0x1db)](q),d[D(0x1ae)](0x1f4)['json']({'error':'Ocorreu\x20um\x20erro\x20ao\x20criar\x20a\x20mensagem.'});}};exports[A(0x1b2)]=criarMensagem;const marcarMensagemNaoLida=async(c,d)=>{const H=z,I=z;try{const {contactId:e}=c[H(0x1ad)],{id:f,tenantId:g}=c[I(0x1a2)],{isGroup:h}=c[I(0x1c8)],i=(0x0,socket_1[H(0x1e1)])();return await(0x0,ReadMessageService_1[I(0x1c5)])({'userId':f,'senderId':e,'isGroup':h}),i['emit'](g+I(0x1b3),{'action':'update','data':{'receiverId':f,'isGroup':h,'senderId':Number(e)}}),d['status'](0xc8)['json']({'message':H(0x1d4)});}catch(j){return console[H(0x1db)](j),d[H(0x1ae)](0x1f4)[H(0x1e3)]({'error':H(0x1a6)});}};exports[z(0x1ab)]=marcarMensagemNaoLida;const listCountUnreadMessage=async(c,d)=>{const J=z,K=z;try{const {id:e}=c['user'],f=await(0x0,ListCountUnreadMessage_1['default'])(e);return d[J(0x1ae)](0xc8)[K(0x1e3)]({'count':f});}catch(g){return'aIGPE'!==K(0x1b8)?(f[K(0x1db)](g),h['status'](0x1f4)['json']({'error':J(0x1a6)})):(console[K(0x1db)](g),d[J(0x1ae)](0x1f4)[K(0x1e3)]({'error':K(0x1cf)}));}};exports[A(0x1c3)]=listCountUnreadMessage;