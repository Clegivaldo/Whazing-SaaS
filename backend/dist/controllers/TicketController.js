'use strict';const v=b,w=b;function a(){const L=['closed','../models/Whatsapp','remove','5UPtsTF','3133422HqDIuI','../models/Ticket','919068ZdKlJg','../services/TicketServices/ShowLogTicketService','../utils/pupa','index','emit','../services/TicketServices/CreateTicketService','default','../services/MessageServices/CreateMessageSystemService',':ticket','../errors/AppError','showLogsTicket','value','ticket\x20deleted','whatsappId','1116983USThih','../services/TicketServices/CreateLogTicketService','not','defineProperty','sequelize','getIO','1522swjNeA','ukySK','5586936OaxaTX','json','findAll','2655mitsIm','__esModule','find','545sJhpan','../services/TicketServices/UpdateTicketService','open','950868CVVfHQ','findOne','../services/TicketServices/DeleteTicketService','body','../services/TicketServices/ShowTicketService','bot','query','../services/SettingServices/ListSettingsService','NotViewAssignedTickets','contact','11940EJZALl','params','userId','update','create','8JZVzcM',':notification','status','user','store','JkUUh','contactId','farewellMessage','pending','../libs/socket','enabled','scheduledMessages','protocol','show','33ibrdyw'];a=function(){return L;};return a();}(function(c,d){const t=b,u=b,e=c();while(!![]){try{const f=parseInt(t(0x213))/0x1*(parseInt(u(0x20b))/0x2)+parseInt(u(0x216))/0x3+parseInt(u(0x1f7))/0x4+-parseInt(t(0x1f4))/0x5*(-parseInt(u(0x1f5))/0x6)+parseInt(t(0x205))/0x7*(-parseInt(t(0x1e2))/0x8)+-parseInt(t(0x210))/0x9*(-parseInt(u(0x1dd))/0xa)+-parseInt(u(0x1f0))/0xb*(parseInt(t(0x20d))/0xc);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x44450));var __importDefault=this&&this['__importDefault']||function(c){return c&&c['__esModule']?c:{'default':c};};Object[v(0x208)](exports,v(0x211),{'value':!![]}),exports[w(0x201)]=exports['remove']=exports[w(0x1e0)]=exports[v(0x1ef)]=exports['store']=exports['index']=void 0x0;const sequelize_1=require(w(0x209)),socket_1=require(v(0x1eb)),Message_1=__importDefault(require('../models/Message')),CreateLogTicketService_1=__importDefault(require(v(0x206))),CreateTicketService_1=__importDefault(require(v(0x1fc))),DeleteTicketService_1=__importDefault(require(w(0x218))),ListTicketsService_1=__importDefault(require('../services/TicketServices/ListTicketsService')),ShowLogTicketService_1=__importDefault(require(v(0x1f8))),ShowTicketService_1=__importDefault(require(w(0x21a))),UpdateTicketService_1=__importDefault(require(v(0x214))),Whatsapp_1=__importDefault(require(w(0x1f2))),AppError_1=__importDefault(require(v(0x200))),CreateMessageSystemService_1=__importDefault(require(w(0x1fe))),pupa_1=require(v(0x1f9)),Ticket_1=__importDefault(require(w(0x1f6))),ListSettingsService_1=__importDefault(require(v(0x21d))),index=async(c,d)=>{const x=w,y=w,{tenantId:e,profile:f}=c[x(0x1e5)],{searchParam:g,pageNumber:h,status:i,date:j,showAll:k,withUnreadMessages:l,queuesIds:m,isNotAssignedUser:n,includeNotQueueDefined:o}=c[y(0x21c)],p=c['user']['id'],{tickets:q,count:r,hasMore:s}=await(0x0,ListTicketsService_1['default'])({'searchParam':g,'pageNumber':h,'status':i,'date':j,'showAll':k,'userId':p,'withUnreadMessages':l,'queuesIds':m,'isNotAssignedUser':n,'includeNotQueueDefined':o,'tenantId':e,'profile':f});return d[y(0x1e4)](0xc8)[x(0x20e)]({'tickets':q,'count':r,'hasMore':s});};exports[w(0x1fa)]=index;const store=async(c,d)=>{const z=v,A=v,{tenantId:e}=c[z(0x1e5)],{contactId:f,status:g,userId:h,channel:i,channelId:j}=c[z(0x219)],k=await Ticket_1[A(0x1fd)]['findOne']({'where':{'contactId':f,[sequelize_1['Op']['or']]:[{'status':A(0x215)},{'status':z(0x1ea)}],'tenantId':e,'channel':i}}),l=await(0x0,ListSettingsService_1[z(0x1fd)])(e),m=l?.[A(0x212)](o=>{const B=z,C=z;if(B(0x1e7)!==C(0x1e7)){const q=(0x0,h['getIO'])();q['to'](i+':'+j[C(0x1e4)])[B(0x1fb)](k+B(0x1ff),{'action':C(0x1e1),'ticket':l});}else return o['key']===C(0x21e);})?.[z(0x202)]===A(0x1ec)?'S':'N';if(k&&!!k['userId']&&k[z(0x1df)]!=h&&m=='S')throw new AppError_1[(A(0x1fd))]('Ticket\x20já\x20atribuido\x20para\x20outro\x20usuário');if(k)return d[z(0x1e4)](0xc8)[z(0x20e)](k);const n=await(0x0,CreateTicketService_1[z(0x1fd)])({'contactId':f,'status':g,'userId':h,'tenantId':e,'channel':i,'channelId':j});if(!h){const o=(0x0,socket_1[A(0x20a)])();o['to'](e+':'+n[z(0x1e4)])[A(0x1fb)](e+z(0x1ff),{'action':z(0x1e1),'ticket':n});}return d[A(0x1e4)](0xc8)[A(0x20e)](n);};function b(c,d){const e=a();return b=function(f,g){f=f-0x1dd;let h=e[f];return h;},b(c,d);}exports[w(0x1e6)]=store;const show=async(c,d)=>{const D=w,E=v,{ticketId:e}=c[D(0x1de)],{tenantId:f}=c[D(0x1e5)],g=c['user']['id'],h=await(0x0,ShowTicketService_1[D(0x1fd)])({'id':e,'tenantId':f}),i={'contactId':h[E(0x1e8)],'scheduleDate':{[sequelize_1['Op'][E(0x207)]]:null},'status':D(0x1ea)},j=await Message_1[E(0x1fd)][E(0x20f)]({'where':i});return h['setDataValue'](D(0x1ed),j),await(0x0,CreateLogTicketService_1[E(0x1fd)])({'userId':g,'ticketId':e,'type':'access'}),d[D(0x1e4)](0xc8)[D(0x20e)](h);};exports[w(0x1ef)]=show;const update=async(c,d)=>{const F=w,G=v,{ticketId:e}=c[F(0x1de)],{tenantId:f}=c['user'],g=c[G(0x1e5)]['id'],{isTransference:h}=c[G(0x219)],i={...c[F(0x219)],'tenantId':f},{ticket:j}=await(0x0,UpdateTicketService_1[G(0x1fd)])({'ticketData':i,'ticketId':e,'isTransference':h,'userIdRequest':g});if(i[G(0x1e4)]===F(0x1f1)){if(G(0x20c)===G(0x20c)){const k=await Whatsapp_1[F(0x1fd)][F(0x217)]({'where':{'id':j[G(0x204)],'tenantId':f}});if(k?.[G(0x1e9)]){const l=(0x0,pupa_1['pupa'])(k[F(0x1e9)]||'',{'protocol':j[F(0x1ee)],'name':j[G(0x21f)]['name']}),m={'msg':{'body':l,'fromMe':!![],'read':!![]},'tenantId':f,'ticket':j,'userId':c['user']['id'],'sendType':G(0x21b),'status':F(0x1ea),'isTransfer':![],'note':![]};await(0x0,CreateMessageSystemService_1['default'])(m),await j['update']({'isFarewellMessage':!![]});}}else return g&&h[F(0x211)]?i:{'default':j};}return d[G(0x1e4)](0xc8)[F(0x20e)](j);};exports['update']=update;const remove=async(c,d)=>{const H=w,I=w,{ticketId:e}=c[H(0x1de)],{tenantId:f}=c[H(0x1e5)],g=c['user']['id'],h=await(0x0,DeleteTicketService_1['default'])({'id':e,'tenantId':f,'userId':g}),i=(0x0,socket_1[I(0x20a)])();return i['to'](f+':'+h[I(0x1e4)])['to'](f+':'+e)['to'](f+I(0x1e3))[H(0x1fb)](f+I(0x1ff),{'action':'delete','ticketId':+e}),d['status'](0xc8)['json']({'message':I(0x203)});};exports[w(0x1f3)]=remove;const showLogsTicket=async(c,d)=>{const J=w,K=w,{ticketId:e}=c[J(0x1de)],f=await(0x0,ShowLogTicketService_1['default'])({'ticketId':e});return d[K(0x1e4)](0xc8)[K(0x20e)](f);};exports[v(0x201)]=showLogsTicket;