'use strict';const q=b,s=b;(function(c,d){const o=b,p=b,e=c();while(!![]){try{const f=-parseInt(o(0x156))/0x1*(-parseInt(p(0x148))/0x2)+parseInt(p(0x14d))/0x3*(parseInt(p(0x14f))/0x4)+parseInt(o(0x154))/0x5+parseInt(o(0x145))/0x6+parseInt(p(0x140))/0x7*(parseInt(o(0x149))/0x8)+-parseInt(o(0x14e))/0x9*(parseInt(o(0x15b))/0xa)+parseInt(o(0x15a))/0xb*(-parseInt(o(0x13f))/0xc);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x52b75));function a(){const v=['body','quotedMsg','defineProperty','10959324sIWSuK','112322WMpFMZ','create','../../helpers/socketEmit','../../utils/pupa','substr','951660XwkeCM','BuildSendMessageService','__esModule','31640wsEMzE','64GISMey','indexOf','message','tenantId','4029mcBJnv','9sYTAai','796BfwoCt','pending','contact','../../utils/logger','default','1939070oUeACi','getTime','21IOYuay','chat:create','contactId','protocol','11lLUEel','221870zUtXtW','findByPk','ticket','pupa','ERR_CREATING_MESSAGE_SYSTEM','mediaUrl','../../models/Message','type','../../utils/queueValidation','update','whatsappId','logger','__importDefault','split','chat','data','../../models/Ticket'];a=function(){return v;};return a();}var __importDefault=this&&this[q(0x167)]||function(c){const r=q;return c&&c[r(0x147)]?c:{'default':c};};Object[s(0x13e)](exports,'__esModule',{'value':!![]});const pupa_1=require(s(0x143)),logger_1=require(s(0x152)),Ticket_1=__importDefault(require(s(0x16b))),Message_1=__importDefault(require(q(0x161))),socketEmit_1=__importDefault(require(s(0x142))),queueValidation_1=__importDefault(require(q(0x163))),BuildSendMessageService=async({msg:c,tenantId:d,ticket:e,userId:f})=>{const t=q,u=q,g={'ticketId':e['id'],'body':'','contactId':e[t(0x158)],'fromMe':!![],'read':!![],'mediaType':u(0x169),'mediaUrl':undefined,'timestamp':new Date()['getTime'](),'quotedMsgId':undefined,'userId':f,'scheduleDate':undefined,'sendType':'bot','status':u(0x150),'tenantId':d};try{if(c[t(0x162)]==='MediaField'&&c[t(0x16a)][t(0x160)]){const h=c[u(0x16a)][u(0x160)][u(0x168)]('/'),i={...g,'body':c[u(0x16a)]['name'],'mediaUrl':h[h['length']-0x1],'mediaType':c[u(0x16a)][t(0x162)]?c['data']?.[u(0x162)][t(0x144)](0x0,c['data'][t(0x162)][t(0x14a)]('/')):u(0x169)},j=await Message_1[u(0x153)][u(0x141)](i),k=await Message_1[u(0x153)]['findByPk'](j['id'],{'include':[{'model':Ticket_1[u(0x153)],'as':t(0x15d),'where':{'tenantId':d},'include':['contact']},{'model':Message_1[u(0x153)],'as':u(0x13d),'include':[t(0x151)]}]});if(!k)throw new Error(t(0x15f));await e['update']({'lastMessage':k[t(0x16c)],'lastMessageAt':new Date()[u(0x155)]()}),await(0x0,queueValidation_1[u(0x153)])(e[t(0x165)],e[u(0x14c)],[k]),(0x0,socketEmit_1[u(0x153)])({'tenantId':d,'type':t(0x157),'payload':k});}else{c[u(0x16a)]['message']=(0x0,pupa_1[t(0x15e)])(c[u(0x16a)][t(0x14b)]||'',{'protocol':e[u(0x159)],'name':e[t(0x151)]['name']});const l=await Message_1[u(0x153)]['create']({...g,'body':c[t(0x16a)]['message'],'mediaType':t(0x169)}),m=await Message_1[t(0x153)][u(0x15c)](l['id'],{'include':[{'model':Ticket_1[u(0x153)],'as':u(0x15d),'where':{'tenantId':d},'include':[u(0x151)]},{'model':Message_1['default'],'as':'quotedMsg','include':[u(0x151)]}]});if(!m)throw new Error('ERR_CREATING_MESSAGE_SYSTEM');await e[u(0x164)]({'lastMessage':m[u(0x16c)],'lastMessageAt':new Date()[t(0x155)](),'answered':!![]}),await(0x0,queueValidation_1[t(0x153)])(e[t(0x165)],e[t(0x14c)],[m]),(0x0,socketEmit_1['default'])({'tenantId':d,'type':'chat:create','payload':m});}}catch(n){logger_1[t(0x166)]['error'](t(0x146),n);}};function b(c,d){const e=a();return b=function(f,g){f=f-0x13d;let h=e[f];return h;},b(c,d);}exports[s(0x153)]=BuildSendMessageService;