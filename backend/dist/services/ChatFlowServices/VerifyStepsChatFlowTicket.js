'use strict';const s=b,u=b;(function(c,d){const q=b,r=b,e=c();while(!![]){try{const f=parseInt(q(0xbb))/0x1*(parseInt(r(0xb7))/0x2)+parseInt(q(0xb8))/0x3*(-parseInt(r(0xa9))/0x4)+-parseInt(r(0xd5))/0x5*(parseInt(q(0xb0))/0x6)+parseInt(q(0xb9))/0x7*(parseInt(r(0x9d))/0x8)+-parseInt(q(0xda))/0x9*(parseInt(q(0xb4))/0xa)+-parseInt(q(0xa6))/0xb+parseInt(r(0xc6))/0xc;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x56886));function a(){const N=['4904181JctSwe','queueId','action','toLowerCase','ZWrmn','jHgRP','__esModule','__importDefault','ticket:update','bot','retriesLimitUserDefine','userId','../OpenIA/VerifyMensageOpenIAQueue','interactions','conditions','default','uMNyC','closed','queue','channel','configurations','map','number','74280DohVqM','userIdDestination','update','ssnUH','status','userDefine','fromMe','chatFlowId','pending','4812445gIVnKj','nextStepId','xSwEc','4ceoZpF','defineProperty','ysKIK','maxRetryBotMessage','ljIzN','sendType','notOptionsSelectMessage','54mTJcRm','key','reload','find','10FKfrtA','getChatFlow','type','2qOzzsj','1088364wmhlCB','371JmHhnK','answerCloseTicket','351971EDIJIq','celularTeste','replace','includes','trim','autoClose','condition','autoDistributeTickets','stepChatFlow','../TicketServices/CreateLogTicketService','retriesLimitQueue','17884536ZQPqJB','../../helpers/socketEmit','isCreated','contact','answered','botRetries','message','flow','from_ia','../WbotServices/helpers/VerifyContactBaileys','../../helpers/SetTicketMessagesAsRead','getBodyMessage','./BuildSendMessageService','findByPk','isGroup','352680aAPfvK','eWNnA','./IsContactTest','../MessageServices/CreateMessageSystemService','tenantId'];a=function(){return N;};return a();}var __importDefault=this&&this[s(0xe1)]||function(c){const t=s;return c&&c[t(0xe0)]?c:{'default':c};};Object[s(0xaa)](exports,'__esModule',{'value':!![]});function b(c,d){const e=a();return b=function(f,g){f=f-0x9b;let h=e[f];return h;},b(c,d);}const socketEmit_1=__importDefault(require(u(0xc7))),CreateMessageSystemService_1=__importDefault(require(s(0xd8))),CreateLogTicketService_1=__importDefault(require(u(0xc4))),BuildSendMessageService_1=__importDefault(require(u(0xd2))),DefinedUserBotService_1=__importDefault(require('./DefinedUserBotService')),IsContactTest_1=__importDefault(require(s(0xd7))),VerifyContactBaileys_1=require(s(0xcf)),VerifyMensageOpenIAQueue_1=__importDefault(require(s(0xe6))),Queue_1=__importDefault(require('./../../models/Queue')),SetTicketMessagesAsRead_1=__importDefault(require(u(0xd0))),isNextSteps=async(c,d,e,f)=>{const v=u,w=u;if(f[v(0xdc)]===0x0){await c[v(0x9f)]({'stepChatFlow':f[w(0xa7)],'botRetries':0x0,'lastInteractionBot':new Date()});const g=[...d[w(0xcd)]['nodeList']],h=g[w(0xb3)](i=>i['id']===f[v(0xa7)]);if(!h)return;for(const i of h['interactions']){await(0x0,BuildSendMessageService_1[v(0xe9)])({'msg':i,'tenantId':c['tenantId'],'ticket':c});}await(0x0,SetTicketMessagesAsRead_1[v(0xe9)])(c);}},isQueueDefine=async(c,d,e,f)=>{const x=u,y=s;if(f[x(0xdc)]===0x1){if(x(0xea)!==x(0xea))e=f[x(0xbc)][x(0xbd)](/\s/g,'');else{c[y(0x9f)]({'queueId':f['queueId'],'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'lastInteractionBot':new Date()}),await(0x0,CreateLogTicketService_1[x(0xe9)])({'ticketId':c['id'],'type':y(0xec),'queueId':f[x(0xdb)]});d?.[x(0xee)]?.[x(0xc2)]&&(await(0x0,DefinedUserBotService_1[x(0xe9)])(c,f[y(0xdb)],c[x(0xd9)],d?.['configurations']?.['autoDistributeTickets']),c['reload']());(0x0,socketEmit_1['default'])({'tenantId':c['tenantId'],'type':y(0xe2),'payload':c});const h=await Queue_1[y(0xe9)][y(0xd3)](f['queueId']);h[x(0xce)]&&await c[x(0x9f)]({'is_chat_ia':!![]}),await(0x0,VerifyMensageOpenIAQueue_1[y(0xe9)])(c,h,!![],!![]);}}},isUserDefine=async(c,d,e)=>{const z=s,A=u;if(e[z(0xdc)]===0x2){if(A(0xa8)!=='xSwEc')return g&&h[z(0xe0)]?i:{'default':j};else await c[z(0x9f)]({'userId':e['userIdDestination'],'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'is_chat_ia':![],'lastInteractionBot':new Date()}),await c[A(0xb2)](),await(0x0,CreateLogTicketService_1[z(0xe9)])({'userId':e[z(0x9e)],'ticketId':c['id'],'type':z(0xa2)}),(0x0,socketEmit_1[A(0xe9)])({'tenantId':c['tenantId'],'type':z(0xe2),'payload':c});}},sendWelcomeMessage=async(c,d)=>{const B=u,C=s;if(d?.[B(0xee)]?.['welcomeMessage']?.[C(0xcc)]){const e={'body':d[C(0xee)]?.['welcomeMessage']['message'],'fromMe':!![],'read':!![],'sendType':'bot'};await(0x0,CreateMessageSystemService_1['default'])({'msg':e,'tenantId':c[B(0xd9)],'ticket':c,'sendType':e['sendType'],'status':B(0xa5)});}},isRetriesLimit=async(c,d)=>{const D=s,E=s,e=d?.[D(0xee)]?.[D(0xac)]?.[D(0x9c)];if(d?.[D(0xee)]?.[E(0xac)]&&e&&c[D(0xcb)]>=e-0x1){if(D(0xa0)!==D(0xa0))g[E(0xe5)]=h,i['userId']=j;else{const g=d[E(0xee)][E(0xac)][D(0xb6)],{destiny:h}=d[D(0xee)][E(0xac)],i={'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'lastInteractionBot':new Date()},j={'ticketId':c['id'],'type':g===0x1?E(0xc5):D(0xe4)};g===0x1&&(i['queueId']=h,j[E(0xdb)]=h);if(g===0x2){if('eWNnA'!==D(0xd6)){if(h[E(0xb6)]==='US')return!![];const l=i[D(0xc1)][D(0x9b)](p=>l(p)[D(0xdd)]()['trim']()),o=k(l)[D(0xdd)]()[E(0xbf)]();return l['includes'](o);}else i[D(0xe5)]=h,j[D(0xe5)]=h;}return c[D(0x9f)](i),(0x0,socketEmit_1[E(0xe9)])({'tenantId':c[D(0xd9)],'type':'ticket:update','payload':c}),await(0x0,CreateLogTicketService_1[D(0xe9)])(j),await sendWelcomeMessage(c,d),!![];}}return![];},isAnswerCloseTicket=async(c,d,e)=>{const F=u,G=s;if(!c?.[F(0xee)]?.[F(0xba)]||c?.[G(0xee)]?.['answerCloseTicket']?.['length']<0x1)return![];const f=c[G(0xee)][F(0xba)][G(0xb3)](g=>{const H=G,I=G;return String(g)['toLowerCase']()['trim']()===String(e)[H(0xdd)]()[H(0xbf)]();});if(f)return'kqqxn'===G(0xdf)?g(h)[G(0xdd)]()[F(0xbf)]()===i(j)['toLowerCase']()[G(0xbf)]():(await d[G(0x9f)]({'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'lastInteractionBot':new Date(),'unreadMessages':0x0,'answered':![],'status':F(0xeb)}),await(0x0,CreateLogTicketService_1[F(0xe9)])({'ticketId':d['id'],'type':G(0xc0)}),(0x0,socketEmit_1[G(0xe9)])({'tenantId':d['tenantId'],'type':F(0xe2),'payload':d}),!![]);return![];},VerifyStepsChatFlowTicket=async(c,d)=>{const J=u,K=u;let e;const f=c[J(0xb1)]?.[J(0xa3)]??c[J(0xa3)];if(d[J(0xa4)]&&d[K(0xa1)]===K(0xa5)&&!f&&!d[K(0xd4)]&&!d[K(0xca)]){if(d[J(0xa4)]){const g=await d[K(0xb5)]();if(g[K(0xbc)]){if(J(0xab)!==K(0xde))e=g['celularTeste'][J(0xbd)](/\s/g,'');else return![];}const h=g[J(0xcd)]['nodeList'][J(0xb3)](m=>m['id']===d[K(0xc3)]),i=g['flow']['nodeList'][K(0xb3)](m=>m[J(0xb6)]===K(0xee)),j=await(0x0,VerifyContactBaileys_1[J(0xd1)])(c),k=h[K(0xe8)][K(0xb3)](m=>{const L=J,M=J;if(L(0xad)===M(0xad)){if(m[M(0xb6)]==='US')return!![];const n=m['condition'][L(0x9b)](p=>String(p)['toLowerCase']()[M(0xbf)]()),o=String(j)[L(0xdd)]()[M(0xbf)]();return n[M(0xbe)](o);}else g[L(0xdb)]=h,i[L(0xdb)]=j;});if(!d['isCreated']&&await isAnswerCloseTicket(i,d,j))return;if(k&&!d[J(0xc8)]){if(await(0x0,IsContactTest_1[K(0xe9)])(d[K(0xc9)][K(0x9c)],e,d[K(0xed)]))return;await isNextSteps(d,g,h,k),await isQueueDefine(d,i,h,k),await isUserDefine(d,h,k),(0x0,socketEmit_1['default'])({'tenantId':d[K(0xd9)],'type':'ticket:update','payload':d}),(k[J(0xdc)]===0x1||k['action']===0x2)&&await sendWelcomeMessage(d,i);}else{if(await(0x0,IsContactTest_1[J(0xe9)])(d[J(0xc9)][J(0x9c)],e,d[J(0xed)]))return;if(!d[K(0xc8)]){if(await isRetriesLimit(d,i))return;const m={'body':i[K(0xee)][J(0xaf)][K(0xcc)]||'Desculpe!\x20Não\x20entendi\x20sua\x20resposta.\x20Vamos\x20tentar\x20novamente!\x20Escolha\x20uma\x20opção\x20válida.','fromMe':!![],'read':!![],'sendType':K(0xe3)};await(0x0,CreateMessageSystemService_1[K(0xe9)])({'msg':m,'tenantId':d[K(0xd9)],'ticket':d,'sendType':m[J(0xae)],'status':K(0xa5)}),await d[J(0x9f)]({'botRetries':d[K(0xcb)]+0x1,'lastInteractionBot':new Date()});}for(const n of h[K(0xe7)]){await(0x0,BuildSendMessageService_1[J(0xe9)])({'msg':n,'tenantId':d[K(0xd9)],'ticket':d});}}await(0x0,SetTicketMessagesAsRead_1[J(0xe9)])(d);}}};exports[s(0xe9)]=VerifyStepsChatFlowTicket;