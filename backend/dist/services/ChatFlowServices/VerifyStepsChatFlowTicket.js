'use strict';const s=b,u=b;(function(c,d){const q=b,r=b,e=c();while(!![]){try{const f=-parseInt(q(0x1f1))/0x1*(-parseInt(q(0x203))/0x2)+parseInt(q(0x1e5))/0x3*(-parseInt(q(0x20f))/0x4)+parseInt(r(0x223))/0x5+-parseInt(r(0x1f4))/0x6+parseInt(q(0x1fe))/0x7*(parseInt(r(0x224))/0x8)+-parseInt(r(0x206))/0x9+-parseInt(r(0x21d))/0xa;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xc228e));function a(){const N=['celularTeste','../TicketServices/CreateLogTicketService','update','pROec','userDefine','type','includes','tenantId','55501tkHRSl','replace','./BuildSendMessageService','6340476oNyzMz','Desculpe!\x20Não\x20entendi\x20sua\x20resposta.\x20Vamos\x20tentar\x20novamente!\x20Escolha\x20uma\x20opção\x20válida.','channel','interactions','isCreated','isGroup','flow','sendType','conditions','key','2532845eDtkXb','contact','message','trim','../../helpers/socketEmit','34paoanP','stepChatFlow','maxRetryBotMessage','151533exiXiJ','findByPk','defineProperty','find','__importDefault','./DefinedUserBotService','kuSYo','condition','chatFlowId','221944yqXtye','GYpRS','jKWKi','pending','autoClose','map','nodeList','bSGMy','status','nextStepId','bLwXA','autoDistributeTickets','action','closed','9078650TIgTxn','getBodyMessage','queueId','configurations','bot','default','3039065KYsrlF','32LcxnWD','../WbotServices/helpers/VerifyContactBaileys','welcomeMessage','reload','./../../models/Queue','answerCloseTicket','./IsContactTest','queue','answered','ticket:update','from_ia','userIdDestination','notOptionsSelectMessage','number','retriesLimitQueue','userId','botRetries','WItVA','toLowerCase','12RgCoMt','fromMe','../../helpers/SetTicketMessagesAsRead','__esModule'];a=function(){return N;};return a();}function b(c,d){const e=a();return b=function(f,g){f=f-0x1d7;let h=e[f];return h;},b(c,d);}var __importDefault=this&&this[s(0x20a)]||function(c){const t=s;return c&&c[t(0x1e8)]?c:{'default':c};};Object[s(0x208)](exports,'__esModule',{'value':!![]});const socketEmit_1=__importDefault(require(s(0x202))),CreateMessageSystemService_1=__importDefault(require('../MessageServices/CreateMessageSystemService')),CreateLogTicketService_1=__importDefault(require(u(0x1ea))),BuildSendMessageService_1=__importDefault(require(s(0x1f3))),DefinedUserBotService_1=__importDefault(require(u(0x20b))),IsContactTest_1=__importDefault(require(s(0x1d8))),VerifyContactBaileys_1=require(s(0x225)),VerifyMensageOpenIAQueue_1=__importDefault(require('../OpenIA/VerifyMensageOpenIAQueue')),Queue_1=__importDefault(require(u(0x228))),SetTicketMessagesAsRead_1=__importDefault(require(u(0x1e7))),isNextSteps=async(c,d,e,f)=>{const v=u,w=u;if(f['action']===0x0){await c[v(0x1eb)]({'stepChatFlow':f[v(0x218)],'botRetries':0x0,'lastInteractionBot':new Date()});const g=[...d[v(0x1fa)]['nodeList']],h=g[w(0x209)](i=>i['id']===f[w(0x218)]);if(!h)return;for(const i of h[w(0x1f7)]){await(0x0,BuildSendMessageService_1[w(0x222)])({'msg':i,'tenantId':c['tenantId'],'ticket':c});}await(0x0,SetTicketMessagesAsRead_1[v(0x222)])(c);}},isQueueDefine=async(c,d,e,f)=>{const x=s,y=s;if(f[x(0x21b)]===0x1){c[x(0x1eb)]({'queueId':f['queueId'],'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'lastInteractionBot':new Date()}),await(0x0,CreateLogTicketService_1[x(0x222)])({'ticketId':c['id'],'type':x(0x1d9),'queueId':f['queueId']});if(d?.['configurations']?.[y(0x21a)]){if(y(0x1e3)!==y(0x1e3))return g(h)[x(0x1e4)]()[y(0x201)]()===i(j)[x(0x1e4)]()[x(0x201)]();else await(0x0,DefinedUserBotService_1[y(0x222)])(c,f[y(0x21f)],c[y(0x1f0)],d?.[x(0x220)]?.['autoDistributeTickets']),c[x(0x227)]();}(0x0,socketEmit_1[y(0x222)])({'tenantId':c['tenantId'],'type':'ticket:update','payload':c});const g=await Queue_1['default'][y(0x207)](f[x(0x21f)]);g[y(0x1dc)]&&(x(0x211)==='TNgvn'?(g['userId']=h,i[y(0x1e1)]=j):await c['update']({'is_chat_ia':!![]})),await(0x0,VerifyMensageOpenIAQueue_1[y(0x222)])(c,g,!![],!![]);}},isUserDefine=async(c,d,e)=>{const z=s,A=u;e[z(0x21b)]===0x2&&(await c[A(0x1eb)]({'userId':e[z(0x1dd)],'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'is_chat_ia':![],'lastInteractionBot':new Date()}),await c[z(0x227)](),await(0x0,CreateLogTicketService_1['default'])({'userId':e[A(0x1dd)],'ticketId':c['id'],'type':A(0x1ed)}),(0x0,socketEmit_1[z(0x222)])({'tenantId':c[A(0x1f0)],'type':'ticket:update','payload':c}));},sendWelcomeMessage=async(c,d)=>{const B=s,C=u;if(d?.[B(0x220)]?.[C(0x226)]?.[C(0x200)]){const e={'body':d[C(0x220)]?.['welcomeMessage'][B(0x200)],'fromMe':!![],'read':!![],'sendType':B(0x221)};await(0x0,CreateMessageSystemService_1[C(0x222)])({'msg':e,'tenantId':c[C(0x1f0)],'ticket':c,'sendType':e['sendType'],'status':C(0x212)});}},isRetriesLimit=async(c,d)=>{const D=u,E=u,e=d?.[D(0x220)]?.[E(0x205)]?.[D(0x1df)];if(d?.[D(0x220)]?.[E(0x205)]&&e&&c[E(0x1e2)]>=e-0x1){const f=d[D(0x220)][D(0x205)]['type'],{destiny:g}=d[E(0x220)]['maxRetryBotMessage'],h={'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'lastInteractionBot':new Date()},i={'ticketId':c['id'],'type':f===0x1?E(0x1e0):'retriesLimitUserDefine'};if(f===0x1){if(E(0x219)!=='bLwXA')return g&&h['__esModule']?i:{'default':j};else h[E(0x21f)]=g,i[D(0x21f)]=g;}if(f===0x2){if(D(0x20c)==='kuSYo')h[E(0x1e1)]=g,i[D(0x1e1)]=g;else return![];}return c[E(0x1eb)](h),(0x0,socketEmit_1[E(0x222)])({'tenantId':c[E(0x1f0)],'type':'ticket:update','payload':c}),await(0x0,CreateLogTicketService_1[E(0x222)])(i),await sendWelcomeMessage(c,d),!![];}return![];},isAnswerCloseTicket=async(c,d,e)=>{const F=s,G=u;if(!c?.[F(0x220)]?.[F(0x1d7)]||c?.[F(0x220)]?.[G(0x1d7)]?.['length']<0x1){if(G(0x210)==='bkXUz'){if(h[F(0x1ee)]==='US')return!![];const h=i[G(0x20d)][F(0x214)](p=>h(p)[G(0x1e4)]()[F(0x201)]()),i=k(l)[G(0x1e4)]()[F(0x201)]();return h[G(0x1ef)](i);}else return![];}const f=c['configurations'][F(0x1d7)][F(0x209)](h=>{const H=F,I=G;if(H(0x216)!==I(0x216))e=f['celularTeste'][H(0x1f2)](/\s/g,'');else return String(h)[I(0x1e4)]()[I(0x201)]()===String(e)[H(0x1e4)]()['trim']();});if(f)return await d['update']({'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'lastInteractionBot':new Date(),'unreadMessages':0x0,'answered':![],'status':G(0x21c)}),await(0x0,CreateLogTicketService_1[G(0x222)])({'ticketId':d['id'],'type':G(0x213)}),(0x0,socketEmit_1[F(0x222)])({'tenantId':d[G(0x1f0)],'type':G(0x1db),'payload':d}),!![];return![];},VerifyStepsChatFlowTicket=async(c,d)=>{const J=s,K=s;let e;const f=c[J(0x1fd)]?.[K(0x1e6)]??c[K(0x1e6)];if(d[K(0x20e)]&&d[J(0x217)]===J(0x212)&&!f&&!d[J(0x1f9)]&&!d[J(0x1da)]){if(d[J(0x20e)]){const g=await d['getChatFlow']();g[K(0x1e9)]&&(e=g[J(0x1e9)]['replace'](/\s/g,''));const h=g['flow'][K(0x215)][K(0x209)](l=>l['id']===d[J(0x204)]),i=g[K(0x1fa)][J(0x215)][K(0x209)](l=>l[K(0x1ee)]===J(0x220)),j=await(0x0,VerifyContactBaileys_1[J(0x21e)])(c),k=h[J(0x1fc)][J(0x209)](l=>{const L=K,M=K;if(l['type']==='US')return!![];const m=l[L(0x20d)][M(0x214)](o=>String(o)['toLowerCase']()['trim']()),n=String(j)[L(0x1e4)]()[M(0x201)]();return m[M(0x1ef)](n);});if(!d[K(0x1f8)]&&await isAnswerCloseTicket(i,d,j))return;if(k&&!d[J(0x1f8)]){if(await(0x0,IsContactTest_1['default'])(d['contact'][J(0x1df)],e,d[J(0x1f6)]))return;await isNextSteps(d,g,h,k),await isQueueDefine(d,i,h,k),await isUserDefine(d,h,k),(0x0,socketEmit_1[J(0x222)])({'tenantId':d['tenantId'],'type':J(0x1db),'payload':d}),(k['action']===0x1||k[K(0x21b)]===0x2)&&await sendWelcomeMessage(d,i);}else{if(await(0x0,IsContactTest_1[K(0x222)])(d[K(0x1ff)][J(0x1df)],e,d[K(0x1f6)]))return;if(!d['isCreated']){if(K(0x1ec)!=='jAHKW'){if(await isRetriesLimit(d,i))return;const l={'body':i[J(0x220)][J(0x1de)][J(0x200)]||J(0x1f5),'fromMe':!![],'read':!![],'sendType':J(0x221)};await(0x0,CreateMessageSystemService_1[K(0x222)])({'msg':l,'tenantId':d[J(0x1f0)],'ticket':d,'sendType':l[K(0x1fb)],'status':K(0x212)}),await d['update']({'botRetries':d[J(0x1e2)]+0x1,'lastInteractionBot':new Date()});}else g['queueId']=h,i[K(0x21f)]=j;}for(const n of h[J(0x1f7)]){await(0x0,BuildSendMessageService_1[K(0x222)])({'msg':n,'tenantId':d[K(0x1f0)],'ticket':d});}}await(0x0,SetTicketMessagesAsRead_1['default'])(d);}}};exports[u(0x222)]=VerifyStepsChatFlowTicket;