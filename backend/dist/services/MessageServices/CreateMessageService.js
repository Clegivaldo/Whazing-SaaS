'use strict';const q=b,s=b;(function(c,d){const o=b,p=b,e=c();while(!![]){try{const f=-parseInt(o(0x1f4))/0x1*(-parseInt(o(0x1fd))/0x2)+parseInt(p(0x218))/0x3+-parseInt(o(0x209))/0x4*(parseInt(p(0x201))/0x5)+parseInt(o(0x200))/0x6+parseInt(p(0x20d))/0x7+parseInt(p(0x20f))/0x8*(-parseInt(p(0x206))/0x9)+-parseInt(o(0x215))/0xa;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x3a844));function a(){const x=['quotedMsg','MKnLs','937023cYcGNd','body','dataJson','../../models/Contact','2OiGTot','mediaType','chat:create','protocolMessage','contactId','default','FnziR','findOne','NyOqP','227058lvfLBz','bZUZQ','Mensagem\x20original\x20nÃ£o\x20encontrada','945066uvsKnm','588715fGFBou','key','editedMessage','fskDS','Zffuy','13086eYqeJz','ERR_CREATING_MESSAGE','QnODH','8TeSXJl','ticket','__importDefault','parse','2511894fSqHSt','message','1000PXLZlu','../../helpers/socketEmit','__esModule','messageId','contact','Erro\x20ao\x20extrair\x20messageId\x20do\x20dataJson','3988320TNnBcC'];a=function(){return x;};return a();}var __importDefault=this&&this[q(0x20b)]||function(c){const r=q;return c&&c[r(0x211)]?c:{'default':c};};Object['defineProperty'](exports,s(0x211),{'value':!![]});const Message_1=__importDefault(require('../../models/Message')),Ticket_1=__importDefault(require('../../models/Ticket')),socketEmit_1=__importDefault(require(s(0x210))),Contact_1=__importDefault(require(q(0x1f3)));function b(c,d){const e=a();return b=function(f,g){f=f-0x1f3;let h=e[f];return h;},b(c,d);}function extractMessageId(c){const t=q,u=q;try{const d=JSON[t(0x20c)](c);return d[u(0x20e)][t(0x203)][t(0x20e)][t(0x1f7)][u(0x202)]['id'];}catch(e){throw new Error(t(0x214));}}const CreateMessageService=async({messageData:c,tenantId:d})=>{const v=s,w=s;if(c[v(0x1f5)]===w(0x203)&&c['dataJson']){if(w(0x1fc)!==w(0x217)){const h=c[w(0x21a)],i=extractMessageId(h),j=await Message_1['default']['findOne']({'where':{'messageId':i,'tenantId':d}});if(j)return await j['update']({'edited':c[w(0x219)]}),(0x0,socketEmit_1['default'])({'tenantId':d,'type':'chat:update','payload':j}),j;else{if(w(0x204)!==v(0x1fa))throw new Error(w(0x1ff));else g=[{'model':h[w(0x1f9)],'as':w(0x20a),'where':{'tenantId':i},'include':[v(0x213)]},{'model':j[w(0x1f9)],'as':w(0x216),'include':[v(0x213)]}];}}else throw new d(v(0x214));}let e=await Message_1['default'][w(0x1fb)]({'where':{'messageId':c[v(0x212)],'tenantId':d}});if(!e)e=await Message_1['default']['create']({...c,'tenantId':d});else{if(w(0x1fe)!==w(0x208))await e['update'](c);else throw new d(w(0x207));}let f;!c['fromMe']?f=[{'model':Ticket_1[w(0x1f9)],'as':w(0x20a),'where':{'tenantId':d},'include':[w(0x213)]},{'model':Message_1[w(0x1f9)],'as':w(0x216),'include':[v(0x213)]},{'model':Contact_1[v(0x1f9)],'as':v(0x213),'where':{'id':c['contactId']}}]:f=[{'model':Ticket_1[v(0x1f9)],'as':v(0x20a),'where':{'tenantId':d},'include':[v(0x213)]},{'model':Message_1[v(0x1f9)],'as':v(0x216),'include':[v(0x213)]}];const g=await Message_1[w(0x1f9)][w(0x1fb)]({'where':{'messageId':c['messageId'],'tenantId':d},'include':f});if(!g){if(v(0x205)!==v(0x205))i=[{'model':j[v(0x1f9)],'as':v(0x20a),'where':{'tenantId':k},'include':[w(0x213)]},{'model':l[v(0x1f9)],'as':'quotedMsg','include':['contact']},{'model':m[v(0x1f9)],'as':v(0x213),'where':{'id':n[w(0x1f8)]}}];else throw new Error(v(0x207));}return(0x0,socketEmit_1['default'])({'tenantId':d,'type':w(0x1f6),'payload':g}),e;};exports[s(0x1f9)]=CreateMessageService;