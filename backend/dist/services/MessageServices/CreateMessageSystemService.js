'use strict';const L=b,N=b;(function(c,d){const J=b,K=b,e=c();while(!![]){try{const f=-parseInt(J(0x144))/0x1*(-parseInt(K(0x133))/0x2)+-parseInt(K(0x132))/0x3+parseInt(J(0x15b))/0x4+parseInt(J(0x140))/0x5+-parseInt(K(0x16d))/0x6+-parseInt(K(0x145))/0x7*(parseInt(J(0x13c))/0x8)+-parseInt(K(0x15e))/0x9*(-parseInt(K(0x171))/0xa);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xb5bf0));function b(c,d){const e=a();return b=function(f,g){f=f-0x129;let h=e[f];return h;},b(c,d);}var __importDefault=this&&this[L(0x175)]||function(c){const M=L;return c&&c[M(0x150)]?c:{'default':c};};function a(){const a0=['indexOf','1232991LUjoRt','mime','authToken','create','body','headers','getTime','mimetype','ZfmOQ','split','DBrFY','stream','chat:create','DJohn','type','5952540YkFWsX','push','message','get','20kboZTH','SlGDL','wrgir','hookMessageStatus','__importDefault','response','LjtHM','rmdirSync','default','all','ZPjfu','../../models/Ticket','add','ERR_CREATING_MESSAGE_SYSTEM','apiConfig','data','axios','../../utils/queueValidation','contact','SNfeS','map','CreateMessageSystemService','pupa','scheduleDate','WebHooksAPI','fromMe','ticket','pipe','1907034TdAIxv','2yAnsqI','finish','nyvEp','../../helpers/socketEmit','quotedMsg','protocol','whatsappId','join','path','8bMTyFP','number','externalKey','dNbys','7208415PbMFEV','status','contactId','ERROR\x20DONWLOAD','817975VaFhfS','4989243guLIHV','content-type','urlMessageStatus','update','name','logger','EEvlP','uuid','public','filename','../../utils/logger','__esModule','KFJmf','defineProperty','createWriteStream','error','findByPk','mediaUrl','../../libs/Queue','API','media','chat','2205172WLujFE','originalname'];a=function(){return a0;};return a();}Object[N(0x152)](exports,'__esModule',{'value':!![]});const fs_1=__importDefault(require('fs')),path_1=require(L(0x13b)),axios_1=__importDefault(require(N(0x181))),mime_1=__importDefault(require(L(0x15f))),uuid_1=require(L(0x14c)),logger_1=require(L(0x14f)),Ticket_1=__importDefault(require(N(0x17c))),Message_1=__importDefault(require('../../models/Message')),socketEmit_1=__importDefault(require(N(0x136))),Queue_1=__importDefault(require(L(0x157))),pupa_1=require('../../utils/pupa'),queueValidation_1=__importDefault(require(N(0x182))),downloadMedia=async c=>{const O=L,P=N;try{if(O(0x151)===P(0x151)){const d=await axios_1[P(0x179)][P(0x170)](c[O(0x156)],{'responseType':P(0x169)}),e=d[O(0x163)][P(0x146)],f=mime_1[P(0x179)],g=f['extension'](e),h=(0x0,uuid_1['v4'])(),i=(0x0,path_1[P(0x13a)])(__dirname,'..','..','..',P(0x14d)),j=h+'.'+g,k=(0x0,path_1[P(0x13a)])(i,j),l={'originalname':j,'filename':j,'mediaType':g};return await new Promise((m,n)=>{const Q=O,R=P;d[Q(0x180)][Q(0x131)](fs_1['default'][Q(0x153)](k))['on'](Q(0x134),async()=>{m(l);})['on'](R(0x154),o=>{const S=Q,T=Q;console[S(0x154)](T(0x143),o),fs_1[T(0x179)][S(0x178)](k,{'recursive':!![]}),n(new Error(o));});}),l;}else e(f);}catch(n){if(P(0x16b)!==P(0x172)){if(n['response'][P(0x141)]===0x194){const o={'ack':-0x1,'body':c[P(0x162)],'messageId':'','number':c[O(0x13d)],'externalKey':c['externalKey'],'error':n[O(0x16f)],'authToken':c[O(0x17f)]['authToken'],'type':'hookMessageStatus'};if(c?.[P(0x17f)]?.[O(0x147)]){if(P(0x166)==='lnZXl')throw new d(O(0x17e));else Queue_1[O(0x179)]['add']('WebHooksAPI',{'url':c[O(0x17f)][P(0x147)],'type':o[O(0x16c)],'payload':o});}return{};}throw new Error(n);}else{const r=f[P(0x165)]['split']('/')[0x1][P(0x167)](';')[0x0];g['filename']=new h()[P(0x164)]()+'.'+r;}}},CreateMessageSystemService=async({msg:c,tenantId:d,medias:e,ticket:f,userId:g,scheduleDate:h,sendType:i,status:j,idFront:k})=>{const U=N,V=L,l={'ticketId':f['id'],'body':c[U(0x162)],'contactId':c?.[V(0x12f)]?null:f[U(0x142)],'fromMe':i===V(0x158)?!![]:c?.['fromMe'],'read':!![],'mediaType':U(0x15a),'mediaUrl':undefined,'timestamp':new Date()['getTime'](),'quotedMsgId':c?.[U(0x137)]?.['id'],'userId':g,'scheduleDate':h,'sendType':i,'status':j,'tenantId':d,'idFront':k};try{l[U(0x162)]=(0x0,pupa_1[V(0x12c)])(c['body']||'',{'protocol':f[V(0x138)],'name':f['contact'][U(0x149)]});if(i===V(0x158)&&c[V(0x156)]){if('ZPjfu'===U(0x17b)){e=[];const m=await downloadMedia(c);e[U(0x16e)](m);}else{if(n[U(0x176)][U(0x141)]===0x194){const o={'ack':-0x1,'body':y[V(0x162)],'messageId':'','number':z[U(0x13d)],'externalKey':A['externalKey'],'error':B[V(0x16f)],'authToken':C[U(0x17f)][V(0x160)],'type':'hookMessageStatus'};return D?.['apiConfig']?.[V(0x147)]&&G[U(0x179)][V(0x17d)]('WebHooksAPI',{'url':H[V(0x17f)][U(0x147)],'type':o['type'],'payload':o}),{};}throw new w(x);}}i===U(0x158)&&!c[U(0x156)]&&c[V(0x159)]&&(e=[],e[V(0x16e)](c[V(0x159)]));if(e)U(0x177)!==V(0x173)?await Promise[U(0x17a)](e[U(0x12a)](async o=>{const W=U,X=V;if('guIIR'!==W(0x135)){try{if(X(0x129)===W(0x129)){if(!o['filename']){const s=o['mimetype']['split']('/')[0x1]['split'](';')[0x0];o[X(0x14e)]=new Date()[X(0x164)]()+'.'+s;}}else{if(!g[X(0x14e)]){const u=k[X(0x165)][X(0x167)]('/')[0x1][W(0x167)](';')[0x0];l['filename']=new m()[W(0x164)]()+'.'+u;}}}catch(u){X(0x168)===X(0x13f)?m[W(0x180)]['pipe'](n[X(0x179)][X(0x153)](o))['on']('finish',async()=>{w(x);})['on'](W(0x154),C=>{const Y=X,Z=X;w[Y(0x154)]('ERROR\x20DONWLOAD',C),x[Y(0x179)][Y(0x178)](y,{'recursive':!![]}),z(new A(C));}):logger_1[W(0x14a)][W(0x154)](u);}const p={...l,'body':o[W(0x15c)],'mediaUrl':o['filename'],'mediaType':o['mediaType']||o['mimetype']['substr'](0x0,o['mimetype'][W(0x15d)]('/'))},q=await Message_1[W(0x179)]['create'](p),r=await Message_1[X(0x179)][W(0x155)](q['id'],{'include':[{'model':Ticket_1['default'],'as':X(0x130),'where':{'tenantId':d},'include':['contact']},{'model':Message_1['default'],'as':'quotedMsg','include':[X(0x183)]}]});if(!r)throw new Error(X(0x17e));await f[W(0x148)]({'lastMessage':r[W(0x162)],'lastMessageAt':new Date()[X(0x164)]()}),(0x0,socketEmit_1[W(0x179)])({'tenantId':d,'type':W(0x16a),'payload':r});if(!r[X(0x12d)]){if(W(0x14b)===X(0x14b))await(0x0,queueValidation_1[W(0x179)])(f[X(0x139)],d,[r]);else throw new d(W(0x17e));}return r;}else{const y={'ack':-0x1,'body':k['body'],'messageId':'','number':l[W(0x13d)],'externalKey':m[X(0x13e)],'error':n[X(0x16f)],'authToken':o[W(0x17f)][X(0x160)],'type':W(0x174)};return p?.['apiConfig']?.[W(0x147)]&&s[X(0x179)][X(0x17d)](X(0x12e),{'url':t['apiConfig'][X(0x147)],'type':y[X(0x16c)],'payload':y}),{};}})):e[V(0x14a)][V(0x154)](V(0x12b),f);else{const p=await Message_1[V(0x179)][V(0x161)]({...l,'mediaType':'chat'}),q=await Message_1[V(0x179)][V(0x155)](p['id'],{'include':[{'model':Ticket_1['default'],'as':U(0x130),'where':{'tenantId':d},'include':[U(0x183)]},{'model':Message_1['default'],'as':V(0x137),'include':['contact']}]});if(!q)throw new Error(U(0x17e));return await f[V(0x148)]({'lastMessage':q['body'],'lastMessageAt':new Date()['getTime'](),'answered':!![]}),q[U(0x130)]=f,(0x0,socketEmit_1[U(0x179)])({'tenantId':d,'type':U(0x16a),'payload':q}),!q[U(0x12d)]&&await(0x0,queueValidation_1[V(0x179)])(f[V(0x139)],d,[q]),q;}}catch(r){logger_1[U(0x14a)][V(0x154)](V(0x12b),r);}};exports[L(0x179)]=CreateMessageSystemService;