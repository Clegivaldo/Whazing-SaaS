'use strict';
const C = b, D = b;
(function (c, d) {
    const A = b, B = b, e = c();
    while (!![]) {
        try {
            const f = -parseInt(A(0xd9)) / (0x1 * 0x2473 + -0x75a + -0x1d18) + -parseInt(B(0xd0)) / (-0x235f + 0x7bc * 0x3 + 0xc2d) * (-parseInt(B(0x115)) / (0x1000 + 0x516 + -0x1 * 0x1513)) + parseInt(A(0xf5)) / (-0x53 * -0x2d + 0x3 * -0x23f + 0x2 * -0x3eb) * (-parseInt(B(0xde)) / (0xdd * 0x10 + 0xb79 + 0x126 * -0x16)) + -parseInt(A(0x106)) / (0xb0 * -0x24 + -0x1acc + 0x3392) * (parseInt(A(0xe9)) / (-0x3b9 * 0x4 + 0x1685 + -0x79a)) + parseInt(A(0xe2)) / (0x185f + -0x1e8e + 0x637) * (parseInt(A(0xfe)) / (-0x1439 + -0x4f * 0x49 + 0xe43 * 0x3)) + -parseInt(B(0xf3)) / (-0x1 * 0x16a9 + -0x21e1 + -0xd5 * -0x44) * (parseInt(B(0xcf)) / (0x1367 + 0x1067 + -0x23c3)) + parseInt(B(0x101)) / (-0xcec + 0x13 * 0x1c4 + -0x1494);
            if (f === d)
                break;
            else
                e['push'](e['shift']());
        } catch (g) {
            e['push'](e['shift']());
        }
    }
}(a, 0x68171 + -0xa5321 + 0xf * 0x9fb9));
function a() {
    const J = [
        '263985cZBusn',
        '/socket',
        'wId',
        'mediaUrl',
        'OffLine',
        '20IFILMK',
        '../../util',
        'nrkfq',
        'gNOgs',
        '576568rJXZtm',
        'FXLlG',
        'cDEQu',
        'fromMe',
        'CreateMess',
        'fault',
        'include',
        '623KYCqrd',
        'APwnF',
        'ls/Ticket',
        'timestamp',
        'split',
        's/logger',
        'SKeZt',
        'defineProp',
        'TicGL',
        'emit',
        '650nrISYA',
        '-appMessag',
        '357548FMuiRk',
        'ERR_CREATI',
        'contactId',
        'writeFile',
        'public',
        'default',
        'mediaType',
        'Service',
        '../../libs',
        '27BnKQyG',
        'ion',
        'nIEQW',
        '16262904oXqVTR',
        'ageOffLine',
        'promisify',
        'bCPWR',
        'WIVHh',
        '13170rvZYsw',
        'WHmip',
        'read',
        'ticketId',
        'getTime',
        'tenantId',
        '__importDe',
        'map',
        'status',
        'erty',
        'error',
        'toString',
        'substr',
        'all',
        'userId',
        '21rEeMmA',
        'YdYYN',
        'body',
        'path',
        'ticket',
        'KGRrQ',
        'util',
        'BhIBC',
        '__esModule',
        'CzWMl',
        'chat',
        'Wkpah',
        'value',
        'findByPk',
        'update',
        '../../mode',
        'ODqaA',
        'buffer',
        'join',
        'create',
        'logger',
        'jUZrU',
        'getIO',
        'mimetype',
        'SsCHk',
        'base64',
        'quotedMsg',
        '100771KamCoX',
        '58270YacSoy',
        'ls/Message',
        'DfblY',
        'NG_MESSAGE',
        'CBiMt',
        'filename',
        'indexOf',
        '-notificat',
        'contact'
    ];
    a = function () {
        return J;
    };
    return a();
}
var __importDefault = this && this[C(0x10c) + C(0xe7)] || function (c) {
    const E = D;
    return c && c[E(0x11d)] ? c : { 'default': c };
};
const k = {};
function b(c, d) {
    const e = a();
    return b = function (f, g) {
        f = f - (0x83f * 0x2 + -0x3d1 + -0xbe8);
        let h = e[f];
        return h;
    }, b(c, d);
}
k[D(0x121)] = !![], Object[C(0xf0) + C(0x10f)](exports, D(0x11d), k);
const fs_1 = require('fs'), util_1 = require(D(0x11b)), path_1 = require(C(0x118)), logger_1 = require(C(0xdf) + C(0xee)), MessageOffLine_1 = __importDefault(require(D(0x124) + D(0xd1) + D(0xdd))), socket_1 = require(C(0xfd) + D(0xda)), Ticket_1 = __importDefault(require(D(0x124) + C(0xeb))), Message_1 = __importDefault(require(D(0x124) + C(0xd1))), writeFileAsync = (0x1 * -0x11 + 0x2245 + 0x2c * -0xc7, util_1[D(0x103)])(fs_1[C(0xf8)]), CreateMessageOffilineService = async ({
        msg: g,
        tenantId: h,
        medias: i,
        ticket: j,
        userId: l
    }) => {
        const F = D, G = C, m = {
                'APwnF': F(0xf6) + F(0xd3),
                'gNOgs': function (q, r) {
                    return q === r;
                },
                'Wkpah': F(0xe0),
                'TicGL': G(0x11c),
                'SKeZt': function (q, r) {
                    return q !== r;
                },
                'KGRrQ': F(0x107),
                'nIEQW': function (q, r, s, t) {
                    return q(r, s, t);
                },
                'YdYYN': F(0xf9),
                'cDEQu': G(0xcd),
                'DfblY': F(0xd8),
                'CBiMt': F(0x119),
                'SsCHk': G(0xce),
                'jUZrU': G(0xc7),
                'CzWMl': F(0x11f),
                'bCPWR': function (q, r) {
                    return q !== r;
                },
                'FXLlG': G(0x125),
                'WIVHh': F(0xe6) + F(0x102) + F(0xfc)
            }, n = (-0x15a5 * 0x1 + -0x96a * 0x1 + -0x1f0f * -0x1, socket_1[F(0xca)])(), o = {};
        o[G(0xdb)] = undefined, o[F(0x109)] = j['id'], o[F(0x117)] = g[F(0x117)], o[G(0xf7)] = j[F(0xf7)], o[G(0xe5)] = g[G(0xe5)], o[G(0x108)] = !![], o[G(0xfb)] = m[G(0x11e)], o[G(0xdc)] = undefined, o[F(0xec)] = undefined, o[F(0x114)] = l;
        const p = o;
        try {
            if (i)
                await Promise[G(0x113)](i[F(0x10d)](async q => {
                    const H = F, I = F;
                    if (m[H(0xe1)](m[I(0x120)], m[I(0xf1)])) {
                        const s = f[H(0xcb)][I(0xed)]('/')[-0x1b4c + 0x6 * -0x290 + 0x2aad * 0x1][I(0xed)](';')[0x1 * -0x20c5 + -0x43 * 0x91 + 0x46b8];
                        g[H(0xd5)] = new h()[I(0x10a)]() + '.' + s;
                    } else {
                        try {
                            if (!q[H(0xd5)]) {
                                if (m[H(0xef)](m[I(0x11a)], m[H(0x11a)]))
                                    throw new u(m[H(0xea)]);
                                else {
                                    const y = q[I(0xcb)][H(0xed)]('/')[-0x29 * -0xcf + -0x95b + 0x1 * -0x17cb][I(0xed)](';')[0x1159 + -0x1f * -0x1 + -0x2b * 0x68];
                                    q[I(0xd5)] = new Date()[I(0x10a)]() + '.' + y;
                                }
                            }
                            await m[H(0x100)](writeFileAsync, (-0x5df + 0x1 * 0x9d + 0x542, path_1[I(0xc6)])(__dirname, '..', '..', '..', '..', m[H(0x116)], q[I(0xd5)]), q[H(0xc5)], m[I(0xe4)]);
                        } catch (z) {
                            logger_1[I(0xc8)][H(0x110)](z);
                        }
                        const s = {
                                ...p,
                                'mediaUrl': q[H(0xd5)],
                                'mediaType': q[H(0xcb)][H(0x112)](-0x16e * -0x1b + -0x2 * 0x7d1 + -0x4 * 0x5be, q[H(0xcb)][I(0xd6)]('/'))
                            }, t = await MessageOffLine_1[H(0xfa)][H(0xc7)](s), u = {};
                        u[H(0x10b)] = h;
                        const v = {};
                        v[H(0xe8)] = [
                            m[H(0xd2)],
                            {
                                'model': Ticket_1[I(0xfa)],
                                'as': m[I(0xd4)],
                                'where': u,
                                'include': [m[H(0xd2)]]
                            },
                            {
                                'model': Message_1[I(0xfa)],
                                'as': m[I(0xcc)],
                                'include': [m[I(0xd2)]]
                            }
                        ];
                        const w = await MessageOffLine_1[I(0xfa)][H(0x122)](t['id'], v);
                        if (!w)
                            throw new Error(m[I(0xea)]);
                        n['to'](h + '-' + w[I(0x109)][H(0x111)]())['to'](h + '-' + w[I(0x119)][H(0x10e)])['to'](h + (H(0xd7) + H(0xff)))[I(0xf2)](h + (H(0xf4) + 'e'), {
                            'action': m[H(0xc9)],
                            'message': w,
                            'ticket': w[H(0x119)],
                            'contact': w[I(0x119)][I(0xd8)]
                        }), await j[I(0x123)]({
                            'lastMessage': w[I(0x117)],
                            'lastMessageAt': new Date()[I(0x10a)]()
                        });
                    }
                }));
            else {
                const q = { ...p };
                q[F(0xfb)] = m[F(0x11e)];
                const r = await MessageOffLine_1[F(0xfa)][G(0xc7)](q), s = {};
                s[F(0x10b)] = h;
                const t = {};
                t[G(0xe8)] = [
                    m[F(0xd2)],
                    {
                        'model': Ticket_1[G(0xfa)],
                        'as': m[F(0xd4)],
                        'where': s,
                        'include': [m[G(0xd2)]]
                    },
                    {
                        'model': Message_1[F(0xfa)],
                        'as': m[G(0xcc)],
                        'include': [m[F(0xd2)]]
                    }
                ];
                const u = await MessageOffLine_1[G(0xfa)][F(0x122)](r['id'], t);
                if (!u)
                    throw new Error(m[G(0xea)]);
                await j[F(0x123)]({
                    'lastMessage': u[G(0x117)],
                    'lastMessageAt': new Date()[G(0x10a)]()
                }), n['to'](h + '-' + u[F(0x109)][G(0x111)]())['to'](h + '-' + u[F(0x119)][G(0x10e)])['to'](h + (F(0xd7) + G(0xff)))[G(0xf2)](h + (F(0xf4) + 'e'), {
                    'action': m[G(0xc9)],
                    'message': u,
                    'ticket': u[G(0x119)],
                    'contact': u[F(0x119)][F(0xd8)]
                });
            }
        } catch (v) {
            if (m[G(0x104)](m[F(0xe3)], m[F(0xe3)])) {
                const x = {};
                return x[F(0xfa)] = j, x && h[F(0x11d)] ? i : x;
            } else
                logger_1[G(0xc8)][G(0x110)](m[F(0x105)], v);
        }
    };
exports[D(0xfa)] = CreateMessageOffilineService;