'use strict';const t=b,u=b;(function(c,d){const r=b,s=b,e=c();while(!![]){try{const f=parseInt(r(0x11c))/0x1*(-parseInt(r(0x11b))/0x2)+-parseInt(r(0x10b))/0x3+parseInt(r(0x10d))/0x4+parseInt(r(0x125))/0x5+-parseInt(r(0x127))/0x6*(parseInt(r(0x109))/0x7)+parseInt(s(0x12d))/0x8+parseInt(s(0x12e))/0x9*(parseInt(r(0x123))/0xa);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xeab55));var __importDefault=this&&this[t(0xf8)]||function(c){return c&&c['__esModule']?c:{'default':c};};function a(){const z=['default','amwgQ','ERR_CREATING_MESSAGE','../../models/MessageOffLine','../../libs/socket','CAgsM','writeFile','bDrpA','base64','ticketId','body','status','map','ticket','69580PcpQen','logger','4347504cdjNyR','filename','656544vLFFJq','util','create','aXAUl','defineProperty','emit','getTime','buffer','update','-notification','join','rNjXD','quotedMsg','contact','532eiuwdN','121BYVFJq','fromMe','split','../../utils/logger','toString','mimetype','error','363640lhmudy','chat','6637730IplwCS','findByPk','1110dbJGsY','indexOf','-appMessage','CreateMessageOffLineService','eUXMn','obkbG','7482984jvqpBH','459JYwcNf','getIO','__esModule','__importDefault','substr','../../models/Ticket'];a=function(){return z;};return a();}function b(c,d){const e=a();return b=function(f,g){f=f-0xf6;let h=e[f];return h;},b(c,d);}Object[t(0x111)](exports,t(0xf7),{'value':!![]});const fs_1=require('fs'),util_1=require(t(0x10e)),path_1=require('path'),logger_1=require(u(0x11f)),MessageOffLine_1=__importDefault(require(t(0xfe))),socket_1=require(t(0xff)),Ticket_1=__importDefault(require(t(0xfa))),Message_1=__importDefault(require('../../models/Message')),writeFileAsync=(0x0,util_1['promisify'])(fs_1[t(0x101)]),CreateMessageOffilineService=async({msg:c,tenantId:d,medias:e,ticket:f,userId:g})=>{const v=t,w=u,h=(0x0,socket_1[v(0xf6)])(),i={'wId':undefined,'ticketId':f['id'],'body':c['body'],'contactId':f['contactId'],'fromMe':c[v(0x11d)],'read':!![],'mediaType':v(0x124),'mediaUrl':undefined,'timestamp':undefined,'userId':g};try{if(e){if(v(0x102)!==w(0x110))await Promise['all'](e[w(0x107)](async j=>{const x=w,y=w;try{if(!j[x(0x10c)]){if(x(0x118)!==y(0x12c)){const n=j[x(0x121)][x(0x11e)]('/')[0x1][x(0x11e)](';')[0x0];j[x(0x10c)]=new Date()[y(0x113)]()+'.'+n;}else throw new d(y(0xfd));}await writeFileAsync((0x0,path_1[y(0x117)])(__dirname,'..','..','..','..','public',j[x(0x10c)]),j[y(0x114)],x(0x103));}catch(p){x(0x12b)!==x(0x12b)?e[x(0x10a)]['error'](f):logger_1[y(0x10a)][y(0x122)](p);}const k={...i,'mediaUrl':j[y(0x10c)],'mediaType':j[y(0x121)][x(0xf9)](0x0,j[y(0x121)][y(0x128)]('/'))},l=await MessageOffLine_1['default']['create'](k),m=await MessageOffLine_1[x(0xfb)][x(0x126)](l['id'],{'include':[x(0x11a),{'model':Ticket_1[x(0xfb)],'as':x(0x108),'where':{'tenantId':d},'include':[x(0x11a)]},{'model':Message_1[y(0xfb)],'as':y(0x119),'include':[x(0x11a)]}]});if(!m)throw new Error(x(0xfd));h['to'](d+'-'+m['ticketId'][x(0x120)]())['to'](d+'-'+m[x(0x108)]['status'])['to'](d+'-notification')[y(0x112)](d+x(0x129),{'action':'create','message':m,'ticket':m[y(0x108)],'contact':m['ticket'][y(0x11a)]}),await f[y(0x115)]({'lastMessage':m[x(0x105)],'lastMessageAt':new Date()['getTime']()});}));else{const k=f['mimetype'][w(0x11e)]('/')[0x1][v(0x11e)](';')[0x0];g[v(0x10c)]=new h()[v(0x113)]()+'.'+k;}}else{const k=await MessageOffLine_1[v(0xfb)][v(0x10f)]({...i,'mediaType':w(0x124)}),l=await MessageOffLine_1[v(0xfb)]['findByPk'](k['id'],{'include':[v(0x11a),{'model':Ticket_1[v(0xfb)],'as':v(0x108),'where':{'tenantId':d},'include':[w(0x11a)]},{'model':Message_1['default'],'as':'quotedMsg','include':[w(0x11a)]}]});if(!l)throw new Error(w(0xfd));await f[v(0x115)]({'lastMessage':l[v(0x105)],'lastMessageAt':new Date()[w(0x113)]()}),h['to'](d+'-'+l[w(0x104)]['toString']())['to'](d+'-'+l[v(0x108)][v(0x106)])['to'](d+w(0x116))[w(0x112)](d+'-appMessage',{'action':w(0x10f),'message':l,'ticket':l[w(0x108)],'contact':l[w(0x108)][v(0x11a)]});}}catch(m){if(v(0xfc)===v(0x100))throw new d(v(0xfd));else logger_1[v(0x10a)][v(0x122)](v(0x12a),m);}};exports[u(0xfb)]=CreateMessageOffilineService;