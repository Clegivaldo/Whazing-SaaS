'use strict';const s=b,u=b;(function(c,d){const q=b,r=b,e=c();while(!![]){try{const f=parseInt(q(0x111))/0x1*(-parseInt(r(0x11c))/0x2)+-parseInt(r(0x136))/0x3+-parseInt(q(0x135))/0x4+parseInt(q(0x125))/0x5*(-parseInt(q(0x107))/0x6)+parseInt(q(0x10a))/0x7*(parseInt(q(0x12b))/0x8)+parseInt(q(0x110))/0x9+parseInt(q(0x115))/0xa*(parseInt(r(0x131))/0xb);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xc76c8));function b(c,d){const e=a();return b=function(f,g){f=f-0x107;let h=e[f];return h;},b(c,d);}var __importDefault=this&&this[s(0x11f)]||function(c){const t=s;return c&&c[t(0x117)]?c:{'default':c};};function a(){const z=['substr','map','join','ERR_CREATING_MESSAGE','286SZwXjq','body','default','mimetype','3443200osjLJO','3082650JPJHAX','emit','219324EjQgVO','../../models/Ticket','gQApb','17801AogsbE','logger','update','getTime','-appMessage','chat','11889891Lpadoh','3dkYlAt','ticket','public','writeFile','871050loKbco','error','__esModule','base64','toString','split','ticketId','567818faBArh','../../models/Message','CreateMessageOffLineService','__importDefault','all','filename','../../models/MessageOffLine','buffer','create','45kcHowW','contact','path','-notification','findByPk','defineProperty','944WPDLTC','quotedMsg'];a=function(){return z;};return a();}Object[s(0x12a)](exports,u(0x117),{'value':!![]});const fs_1=require('fs'),util_1=require('util'),path_1=require(s(0x127)),logger_1=require('../../utils/logger'),MessageOffLine_1=__importDefault(require(u(0x122))),socket_1=require('../../libs/socket'),Ticket_1=__importDefault(require(u(0x108))),Message_1=__importDefault(require(u(0x11d))),writeFileAsync=(0x0,util_1['promisify'])(fs_1[s(0x114)]),CreateMessageOffilineService=async({msg:c,tenantId:d,medias:e,ticket:f,userId:g})=>{const v=s,w=u,h=(0x0,socket_1['getIO'])(),i={'wId':undefined,'ticketId':f['id'],'body':c['body'],'contactId':f['contactId'],'fromMe':c['fromMe'],'read':!![],'mediaType':'chat','mediaUrl':undefined,'timestamp':undefined,'userId':g};try{if(e)'gQApb'!==v(0x109)?e['logger'][v(0x116)](f):await Promise[v(0x120)](e[w(0x12e)](async k=>{const x=w,y=v;try{if(!k[x(0x121)]){const o=k[y(0x134)][y(0x11a)]('/')[0x1][y(0x11a)](';')[0x0];k[y(0x121)]=new Date()[y(0x10d)]()+'.'+o;}await writeFileAsync((0x0,path_1[y(0x12f)])(__dirname,'..','..','..','..',x(0x113),k[x(0x121)]),k[y(0x123)],y(0x118));}catch(p){logger_1[y(0x10b)][y(0x116)](p);}const l={...i,'mediaUrl':k[x(0x121)],'mediaType':k[x(0x134)][y(0x12d)](0x0,k[x(0x134)]['indexOf']('/'))},m=await MessageOffLine_1[y(0x133)][x(0x124)](l),n=await MessageOffLine_1[y(0x133)]['findByPk'](m['id'],{'include':[y(0x126),{'model':Ticket_1[y(0x133)],'as':'ticket','where':{'tenantId':d},'include':['contact']},{'model':Message_1[x(0x133)],'as':x(0x12c),'include':[y(0x126)]}]});if(!n)throw new Error(y(0x130));h['to'](d+'-'+n['ticketId'][x(0x119)]())['to'](d+'-'+n[x(0x112)]['status'])['to'](d+'-notification')[y(0x137)](d+y(0x10e),{'action':y(0x124),'message':n,'ticket':n['ticket'],'contact':n[y(0x112)][x(0x126)]}),await f[x(0x10c)]({'lastMessage':n[y(0x132)],'lastMessageAt':new Date()[x(0x10d)]()});}));else{const k=await MessageOffLine_1[w(0x133)][w(0x124)]({...i,'mediaType':v(0x10f)}),l=await MessageOffLine_1['default'][v(0x129)](k['id'],{'include':[v(0x126),{'model':Ticket_1[v(0x133)],'as':v(0x112),'where':{'tenantId':d},'include':[v(0x126)]},{'model':Message_1['default'],'as':'quotedMsg','include':[v(0x126)]}]});if(!l)throw new Error('ERR_CREATING_MESSAGE');await f[w(0x10c)]({'lastMessage':l[v(0x132)],'lastMessageAt':new Date()[w(0x10d)]()}),h['to'](d+'-'+l[v(0x11b)]['toString']())['to'](d+'-'+l[w(0x112)]['status'])['to'](d+w(0x128))[w(0x137)](d+w(0x10e),{'action':'create','message':l,'ticket':l[v(0x112)],'contact':l[v(0x112)][w(0x126)]});}}catch(m){logger_1[v(0x10b)][w(0x116)](w(0x11e),m);}};exports[u(0x133)]=CreateMessageOffilineService;