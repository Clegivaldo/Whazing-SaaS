'use strict';function a(){const z=['20840FrJgZq','get','defineProperty','776888OrUzPI','logger','GET','__esModule','/accounts?access_token=','5142JlSymz','env','axios','72bDSNuT','update','length','../../errors/AppError','&client_secret=',':whatsappSession','/accounts?limit=25&access_token=','3630naZegC','default','../../utils/logger','access_token','https://graph.facebook.com/','876778EEPVnr','880749qFUmLa','&fb_exchange_token=','v16.0','__importDefault','../../libs/socket','../../models/Whatsapp','./SetLogoutLinkedPage','emit','2qsfdan','214318YJXosf','1348mfOCtB','FACEBOOK_APP_ID','24135BEQOng','Escolha\x20apenas\x201\x20página.\x20Refaça\x20o\x20processo\x20e\x20selecione\x20apenas\x201\x20página.'];a=function(){return z;};return a();}const o=b,q=b;function b(c,d){const e=a();return b=function(f,g){f=f-0x11a;let h=e[f];return h;},b(c,d);}(function(c,d){const m=b,n=b,e=c();while(!![]){try{const f=parseInt(m(0x121))/0x1*(parseInt(m(0x122))/0x2)+parseInt(n(0x12f))/0x3*(-parseInt(m(0x123))/0x4)+parseInt(m(0x125))/0x5*(-parseInt(m(0x132))/0x6)+-parseInt(n(0x13e))/0x7+parseInt(n(0x12a))/0x8+parseInt(m(0x13f))/0x9+parseInt(m(0x127))/0xa*(parseInt(n(0x139))/0xb);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x52156));var __importDefault=this&&this[o(0x11c)]||function(c){const p=o;return c&&c[p(0x12d)]?c:{'default':c};};Object[o(0x129)](exports,q(0x12d),{'value':!![]});const axios_1=__importDefault(require(q(0x131))),AppError_1=__importDefault(require(o(0x135))),Whatsapp_1=__importDefault(require(q(0x11e))),SetLogoutLinkedPage_1=__importDefault(require(o(0x11f))),socket_1=require(o(0x11d)),logger_1=require(q(0x13b)),api_version=o(0x11b),baseUrl=q(0x13d)+api_version,app_id=process[o(0x130)][o(0x124)],app_secret=process[o(0x130)]['FACEBOOK_APP_SECRET_KEY'],getLongLivedAccessToken=async c=>{const r=o,s=q,{data:d}=await axios_1['default']['get'](baseUrl+'/oauth/access_token?grant_type=fb_exchange_token&client_id='+app_id+r(0x136)+app_secret+r(0x11a)+c);return d[s(0x13c)];},getPermanentPageAccessToken=async(c,d)=>{const t=o,u=o,{data:{data:e}}=await axios_1[t(0x13a)][u(0x128)](baseUrl+'/'+d+u(0x12e)+c);return e[t(0x134)]&&e[0x0];},getPageInfo=async(c,d)=>{const v=q,w=q,e=baseUrl+'/'+c+v(0x138)+d,{data:{data:f}}=await(0x0,axios_1[w(0x13a)])({'method':w(0x12c),'url':e});return f;},GetTokenAndLinkedPage=async({whatsapp:c,accountId:d,userToken:e,tenantId:f})=>{const x=q,y=o;try{const g=(0x0,socket_1['getIO'])(),h=await getPageInfo(d,e);if(h[x(0x134)]>0x1)throw new AppError_1[(y(0x13a))](x(0x126),0x190);if(h[y(0x134)]===0x0){await(0x0,SetLogoutLinkedPage_1['default'])({'whatsapp':c,'tenantId':f});return;}const i=await getLongLivedAccessToken(e),j=await getPermanentPageAccessToken(i,d),k={'status':'CONNECTED','fbPageId':j['id'],'fbObject':{...j,'accountId':d,'long_lived_access_token':i},'tokenAPI':j[y(0x13c)]};Whatsapp_1[x(0x13a)][y(0x133)](k,{'where':{'id':c['id'],'tenantId':f}}),g[y(0x120)](f+x(0x137),{'action':'update','session':{...c,...k}});}catch(l){logger_1[x(0x12b)]['error'](l);throw new AppError_1[(x(0x13a))](l,0x190);}};exports[q(0x13a)]=GetTokenAndLinkedPage;