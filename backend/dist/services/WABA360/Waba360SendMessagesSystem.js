'use strict';const o=b,p=b;(function(c,d){const m=b,n=b,e=c();while(!![]){try{const f=-parseInt(m(0xfb))/0x1+parseInt(m(0xdf))/0x2*(-parseInt(m(0xc4))/0x3)+parseInt(n(0xf5))/0x4*(-parseInt(m(0xd2))/0x5)+parseInt(n(0xe2))/0x6+parseInt(m(0xc7))/0x7*(parseInt(n(0xe7))/0x8)+parseInt(n(0xe5))/0x9*(-parseInt(n(0xd8))/0xa)+parseInt(n(0xf1))/0xb*(parseInt(m(0xe0))/0xc);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xe7fe3));var __importDefault=this&&this[o(0xe9)]||function(c){return c&&c['__esModule']?c:{'default':c};};function b(c,d){const e=a();return b=function(f,g){f=f-0xc4;let h=e[f];return h;},b(c,d);}function a(){const u=['logger','Message\x20Update\x20ok','messages','tokenAPI','XVdXi','update','62008fGWKCD','36DjTtBQ','mediaName','8502738qOOdfE','tenantId','default','45HdNzur','../../models/Ticket','872xHmGAF','text','__importDefault','chat:ack','video','ASC','chat','messageId','audio','sequelize','10989022cMOvkE','wabaMediaId','number','sended','16PHrnAv','quotedMsg','mediaUrl','../../helpers/socketEmit','body','image','1822969ppqweM','102yCQPcz','mediaType','document','82390IrGLMK','./SentMessage','waba','whatsapp','fQmpe','application','findAll','../../models/Message','contact','includes','ticket','764395BfAEqv','dataValues','pending','voice','defineProperty','info','2516390hoXzPI'];a=function(){return u;};return a();}Object[p(0xd6)](exports,'__esModule',{'value':!![]});const sequelize_1=require(o(0xf0)),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),socketEmit_1=__importDefault(require(o(0xf8))),Message_1=__importDefault(require(p(0xce))),Ticket_1=__importDefault(require(p(0xe6))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),logger_1=require('../../utils/logger'),SentMessage_1=__importDefault(require(p(0xc8))),buildWabaMessage360=async(c,d)=>{const q=p,r=p;let e={'timestamp':String(c['timestamp']),'recipient_type':'individual','to':d,'type':'text'};return(c[q(0xc5)]===r(0xcc)||c['mediaType']===q(0xc6))&&(r(0xcb)==='fQmpe'?e={...e,'type':q(0xc6),'document':{'id':c[r(0xf2)],'caption':c[r(0xf9)]||c[q(0xe1)]||''||''}}:h={...i,'type':r(0xef),'audio':{'id':j[r(0xf2)],'caption':k['body']||l[r(0xe1)]||''}}),c[q(0xc5)]===q(0xfa)&&(e={...e,'type':r(0xfa),'image':{'id':c[r(0xf2)],'caption':c[r(0xf9)]||c['mediaName']||''}}),c['mediaType']==='video'&&(e={...e,'type':q(0xeb),'video':{'id':c[r(0xf2)],'caption':c[r(0xf9)]||c[r(0xe1)]||''}}),(c[r(0xc5)]===q(0xef)||c[r(0xc5)]===q(0xd5))&&(e={...e,'type':q(0xef),'audio':{'id':c[r(0xf2)],'caption':c[r(0xf9)]||c[r(0xe1)]||''}}),(c[q(0xc5)]===r(0xed)||c[q(0xc5)]===r(0xe8))&&(e={...e,'text':{'body':c[r(0xf9)]}}),e;},where={'fromMe':!![],'messageId':{[sequelize_1['Op']['is']]:null},'status':p(0xd4),[sequelize_1['Op']['or']]:[{'scheduleDate':{[sequelize_1['Op']['lte']]:new Date()}},{'scheduleDate':{[sequelize_1['Op']['is']]:null}}]},Waba360SendMessagesSystem=async c=>{const s=o,t=p,d=await Message_1[s(0xe4)][s(0xcd)]({'where':where,'include':[t(0xcf),{'model':Ticket_1[t(0xe4)],'as':s(0xd1),'where':{'tenantId':c['tenantId'],'channel':t(0xc9)},'include':[s(0xcf),{'model':Whatsapp_1[t(0xe4)],'as':t(0xca),'where':{'id':c['id'],'type':'waba','wabaBSP':'360'}}]},{'model':Message_1[t(0xe4)],'as':s(0xf6),'include':[s(0xcf)]}],'order':[['createdAt',t(0xec)]]});for(const e of d){if('XVdXi'!==s(0xdd))h={...i,'type':t(0xfa),'image':{'id':j[s(0xf2)],'caption':k[s(0xf9)]||l[s(0xe1)]||''}};else{const {ticket:g}=e,h=String(g['contact'][t(0xf3)]);if(!['text','chat'][s(0xd0)](e[t(0xc5)])&&e[t(0xf7)]&&!e[s(0xf2)]){}const i=await buildWabaMessage360(e,h),j=await(0x0,SentMessage_1[t(0xe4)])({'message':i,'apiKey':c[t(0xdc)]}),k={...e,'messageId':j[s(0xdb)][0x0]['id'],'status':t(0xf4),'ack':0x2};await Message_1[t(0xe4)][s(0xde)]({...k},{'where':{'id':e['id']}}),(0x0,socketEmit_1[s(0xe4)])({'tenantId':g[t(0xe3)],'type':s(0xea),'payload':{...k[s(0xd3)],'mediaUrl':e[t(0xf7)],'messageId':k[t(0xee)],'status':t(0xf4),'ack':0x2}}),logger_1[s(0xd9)][s(0xd7)](t(0xda)),await(0x0,SetTicketMessagesAsRead_1['default'])(g);}}};exports[p(0xe4)]=Waba360SendMessagesSystem;