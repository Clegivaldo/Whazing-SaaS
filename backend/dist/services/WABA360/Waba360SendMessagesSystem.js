'use strict';const o=b,p=b;function a(){const u=['360','8934WcenzJ','mediaName','sequelize','text','quotedMsg','waba','defineProperty','8858794qgPBBQ','2426682zliFZy','mediaType','xJdzT','lTzOE','__esModule','document','contact','body','../../models/Message','../../utils/logger','mediaUrl','2419312efoEdZ','../../helpers/SetTicketMessagesAsRead','Message\x20Update\x20ok','includes','audio','ticket','1334548YTIZPA','voice','./SentMessage','../../models/Whatsapp','whatsapp','408201BwvOOI','video','lte','update','wabaMediaId','image','chat','createdAt','sended','__importDefault','27160hWdldf','YDQfJ','individual','../../helpers/socketEmit','messageId','default','2850ZmBxzj','number','application','tokenAPI'];a=function(){return u;};return a();}(function(c,d){const m=b,n=b,e=c();while(!![]){try{const f=parseInt(m(0x1eb))/0x1+-parseInt(m(0x213))/0x2+parseInt(m(0x208))/0x3+parseInt(n(0x1e6))/0x4+-parseInt(n(0x1fb))/0x5*(parseInt(m(0x200))/0x6)+parseInt(n(0x207))/0x7+-parseInt(n(0x1f5))/0x8;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xb833d));var __importDefault=this&&this[o(0x1f4)]||function(c){return c&&c['__esModule']?c:{'default':c};};function b(c,d){const e=a();return b=function(f,g){f=f-0x1e5;let h=e[f];return h;},b(c,d);}Object[o(0x206)](exports,o(0x20c),{'value':!![]});const sequelize_1=require(o(0x202)),SetTicketMessagesAsRead_1=__importDefault(require(o(0x214))),socketEmit_1=__importDefault(require(p(0x1f8))),Message_1=__importDefault(require(o(0x210))),Ticket_1=__importDefault(require('../../models/Ticket')),Whatsapp_1=__importDefault(require(o(0x1e9))),logger_1=require(o(0x211)),SentMessage_1=__importDefault(require(p(0x1e8))),buildWabaMessage360=async(c,d)=>{const q=o,r=p;let e={'timestamp':String(c['timestamp']),'recipient_type':q(0x1f7),'to':d,'type':r(0x203)};return(c[q(0x209)]===q(0x1fd)||c[r(0x209)]===r(0x20d))&&(e={...e,'type':'document','document':{'id':c[r(0x1ef)],'caption':c[r(0x20f)]||c[r(0x201)]||''||''}}),c[q(0x209)]==='image'&&(e={...e,'type':r(0x1f0),'image':{'id':c[q(0x1ef)],'caption':c['body']||c['mediaName']||''}}),c[r(0x209)]===r(0x1ec)&&('pcDdz'===r(0x1f6)?h={...i,'type':r(0x20d),'document':{'id':j[q(0x1ef)],'caption':k[q(0x20f)]||l['mediaName']||''||''}}:e={...e,'type':q(0x1ec),'video':{'id':c[r(0x1ef)],'caption':c[r(0x20f)]||c['mediaName']||''}}),(c['mediaType']===q(0x217)||c[r(0x209)]===q(0x1e7))&&('xJdzT'===q(0x20a)?e={...e,'type':'audio','audio':{'id':c['wabaMediaId'],'caption':c['body']||c[r(0x201)]||''}}:h={...i,'type':'video','video':{'id':j['wabaMediaId'],'caption':k[q(0x20f)]||l[q(0x201)]||''}}),(c[r(0x209)]===r(0x1f1)||c[q(0x209)]===r(0x203))&&(r(0x20b)==='SvJSr'?h={...i,'type':'image','image':{'id':j[r(0x1ef)],'caption':k['body']||l[q(0x201)]||''}}:e={...e,'text':{'body':c[r(0x20f)]}}),e;},where={'fromMe':!![],'messageId':{[sequelize_1['Op']['is']]:null},'status':'pending',[sequelize_1['Op']['or']]:[{'scheduleDate':{[sequelize_1['Op'][p(0x1ed)]]:new Date()}},{'scheduleDate':{[sequelize_1['Op']['is']]:null}}]},Waba360SendMessagesSystem=async c=>{const s=o,t=o,d=await Message_1['default']['findAll']({'where':where,'include':[s(0x20e),{'model':Ticket_1[s(0x1fa)],'as':s(0x1e5),'where':{'tenantId':c['tenantId'],'channel':t(0x205)},'include':[s(0x20e),{'model':Whatsapp_1['default'],'as':t(0x1ea),'where':{'id':c['id'],'type':s(0x205),'wabaBSP':s(0x1ff)}}]},{'model':Message_1[s(0x1fa)],'as':t(0x204),'include':['contact']}],'order':[[t(0x1f2),'ASC']]});for(const e of d){const {ticket:f}=e,g=String(f[s(0x20e)][t(0x1fc)]);if(!['text',s(0x1f1)][t(0x216)](e[t(0x209)])&&e[t(0x212)]&&!e['wabaMediaId']){}const h=await buildWabaMessage360(e,g),i=await(0x0,SentMessage_1[s(0x1fa)])({'message':h,'apiKey':c[t(0x1fe)]}),j={...e,'messageId':i['messages'][0x0]['id'],'status':t(0x1f3),'ack':0x2};await Message_1['default'][s(0x1ee)]({...j},{'where':{'id':e['id']}}),(0x0,socketEmit_1[t(0x1fa)])({'tenantId':f['tenantId'],'type':'chat:ack','payload':{...j['dataValues'],'mediaUrl':e[s(0x212)],'messageId':j[s(0x1f9)],'status':t(0x1f3),'ack':0x2}}),logger_1['logger']['info'](t(0x215)),await(0x0,SetTicketMessagesAsRead_1[t(0x1fa)])(f);}};exports[o(0x1fa)]=Waba360SendMessagesSystem;