'use strict';function a(){const J=['tenantId','getTime','date','9stzDsY','is_animated','sticker','__esModule','photo','pipe','350WILKwK','error','../../utils/logger','length','487514NmdVSK','message_id','7564gDHutp','writeFile','file_id','util','getFileLink','stream','data','399lpFUgW','message','telegram','2372912llUKsn','axios','default','audio','../../helpers/getQuotedForMessageId','toString','151485eXqLCS','mime_type','join','11828930pFKLfE','fileId','split','finish','__importDefault','reply_to_message','ERROR\x20DONWLOAD','logger','606FuYNhZ','caption','path','ERR_DOWNLOAD_MEDIA::\x20ID:\x20','image/webp','mimeType','file_name','sended','1677450tZkgeT','text','update','GET','voice','promisify','image/png','document','video'];a=function(){return J;};return a();}const w=b,y=b;(function(c,d){const u=b,v=b,e=c();while(!![]){try{const f=parseInt(u(0x209))/0x1+-parseInt(v(0x1f7))/0x2+parseInt(v(0x200))/0x3*(-parseInt(v(0x1f9))/0x4)+-parseInt(u(0x21c))/0x5+parseInt(v(0x214))/0x6*(parseInt(u(0x1f3))/0x7)+-parseInt(v(0x203))/0x8+-parseInt(v(0x1ed))/0x9*(-parseInt(v(0x20c))/0xa);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x33c60));var __importDefault=this&&this[w(0x210)]||function(c){const x=w;return c&&c[x(0x1f0)]?c:{'default':c};};Object['defineProperty'](exports,'__esModule',{'value':!![]});function b(c,d){const e=a();return b=function(f,g){f=f-0x1e3;let h=e[f];return h;},b(c,d);}const path_1=require(y(0x216)),util_1=require(w(0x1fc)),fs_1=require('fs'),axios_1=__importDefault(require(w(0x204))),CreateMessageService_1=__importDefault(require('../MessageServices/CreateMessageService')),logger_1=require(y(0x1f5)),getQuotedForMessageId_1=__importDefault(require(w(0x207))),writeFileAsync=(0x0,util_1[y(0x1e6)])(fs_1[y(0x1fa)]),getMediaInfo=c=>{const z=w,A=y,d=c['photo']?z(0x1f1):c[A(0x1e9)]?A(0x1e9):c[z(0x206)]?A(0x206):c['voice']?z(0x1e5):c[z(0x1ef)]&&!c[A(0x1ef)][z(0x1ee)]?z(0x1ef):A(0x1e8),e=c[d],[f,g,h,i,j,k,l]=[d,e[z(0x20a)]?e[A(0x20a)]:'',![],null,e[z(0x1fb)]?e[A(0x1fb)]:e[e[z(0x1f6)]-0x1][z(0x1fb)],c['caption']?c[z(0x215)]:'',d==A(0x1e5)];switch(d){case z(0x1f1):return{'type':f,'mimeType':z(0x1e7),'SAD':h,'fileName':i,'fileId':j,'caption':k,'SAV':l};break;case A(0x1e9):return{'type':f,'mimeType':g,'SAD':h,'fileName':i,'fileId':j,'caption':k,'SAV':l};break;case'audio':return{'type':f,'mimeType':g,'SAD':h,'fileName':i,'fileId':j,'caption':k,'SAV':l};break;case'voice':return{'type':f,'mimeType':g,'SAD':h,'fileName':i,'fileId':j,'caption':k,'SAV':l};break;case A(0x1ef):return{'type':f,'mimeType':z(0x218),'SAD':h,'fileName':i,'fileId':j,'caption':k,'SAV':l,'SAS':!![]};break;default:return{'type':f,'mimeType':g,'SAD':!![],'fileName':e[z(0x21a)]?e[A(0x21a)]:null,'fileId':j,'caption':k,'SAV':l};break;}},downloadFile=async(c,d)=>{const B=y,C=y,e=await(0x0,axios_1[B(0x205)])({'url':c[B(0x208)](),'method':C(0x1e4),'responseType':B(0x1fe)});await new Promise((f,g)=>{const D=C,E=B;e[D(0x1ff)][D(0x1f2)]((0x0,fs_1['createWriteStream'])(d))['on'](D(0x20f),async()=>f(!![]))['on'](D(0x1f4),h=>{const F=D,G=D;console[F(0x1f4)](G(0x212),h),g(new Error(h));});});},VerifyMediaMessage=async(c,d,e,f)=>{const H=w,I=w;let g,h={};g=c?.[H(0x201)],h=c?.[H(0x1e3)];!g&&h&&(g=h?.['edited_message']);const i=await getMediaInfo(g),j=await c[I(0x202)]['getFile'](i[H(0x20d)]);if(!j){logger_1[H(0x213)]['error'](I(0x217)+g[I(0x1f8)]);return;}const k=i[H(0x219)][I(0x20e)]('/')[0x1][H(0x20e)](';')[0x0],l=j[I(0x1fb)]+'_'+new Date()[H(0x1eb)]()+'.'+k,m=(0x0,path_1[H(0x20b)])(__dirname,'..','..','..','public',l),n=await c['telegram'][I(0x1fd)](i[I(0x20d)]);await downloadFile(n,m);let o;if(g?.[H(0x211)]?.['message_id']){const r=await(0x0,getQuotedForMessageId_1[I(0x205)])(g[H(0x211)]['message_id'],e[I(0x1ea)]);o=r?.['id']||undefined;}const p={'messageId':String(g?.[I(0x1f8)]),'ticketId':e['id'],'contactId':d?undefined:f['id'],'body':g[H(0x21d)]||g[I(0x215)]||l,'fromMe':d,'read':d,'mediaUrl':l,'mediaType':i[I(0x219)]['split']('/')[0x0],'quotedMsgId':o,'timestamp':+g[I(0x1ec)]*0x3e8,'status':d?I(0x21b):'received'};await e[I(0x1e3)]({'lastMessage':g['text']||g[I(0x215)]||l,'lastMessageAt':new Date()[I(0x1eb)](),'answered':d||![]});const q=await(0x0,CreateMessageService_1[H(0x205)])({'messageData':p,'tenantId':e[H(0x1ea)]});return q;};exports[w(0x205)]=VerifyMediaMessage;