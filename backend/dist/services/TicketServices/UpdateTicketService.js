'use strict';function b(c,d){const e=a();return b=function(f,g){f=f-0x1b0;let h=e[f];return h;},b(c,d);}const w=b,y=b;function a(){const B=['../../errors/AppError','../../models/Ticket','4600842XOLHtS','../../helpers/socketEmit','__importDefault','661654QoNHnz','__esModule','HspwY','wallets','7749VeQgoW','defineProperty','open','UZnnX','closed','startedAttendanceAt','isTransference','pending','5pGmPzX','../../models/User','findOne','closedAt','1609172BzgTfW','../../helpers/CheckContactOpenTickets','status','transfered','421527xxqsqg','ERR_NO_TICKET_FOUND','stepAutoReplyId','ticket:update','./CreateLogTicketService','XYUeO','autoReplyId','tags','default','name','getTime','setDataValue','notification:new','contact','5ukcrcl','2744280leNpmr','../../models/Contact','5784DpUkLV','receivedTransfer','user','34337670sFJgsP'];a=function(){return B;};return a();}(function(c,d){const u=b,v=b,e=c();while(!![]){try{const f=-parseInt(u(0x1d8))/0x1*(parseInt(v(0x1cc))/0x2)+-parseInt(v(0x1b2))/0x3+parseInt(u(0x1dc))/0x4*(-parseInt(u(0x1c0))/0x5)+parseInt(u(0x1c9))/0x6+parseInt(v(0x1d0))/0x7*(-parseInt(v(0x1c3))/0x8)+-parseInt(v(0x1c1))/0x9+parseInt(u(0x1c6))/0xa;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xdb534));var __importDefault=this&&this[w(0x1cb)]||function(c){const x=w;return c&&c[x(0x1cd)]?c:{'default':c};};Object[y(0x1d1)](exports,y(0x1cd),{'value':!![]});const AppError_1=__importDefault(require(y(0x1c7))),CheckContactOpenTickets_1=__importDefault(require(w(0x1dd))),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),Contact_1=__importDefault(require(y(0x1c2))),Ticket_1=__importDefault(require(w(0x1c8))),User_1=__importDefault(require(y(0x1d9))),socketEmit_1=__importDefault(require(y(0x1ca))),CreateLogTicketService_1=__importDefault(require(w(0x1b6))),UpdateTicketService=async({ticketData:c,ticketId:d,isTransference:e,userIdRequest:f})=>{const z=w,A=w,{status:g,userId:h,tenantId:i,queueId:j}=c,k=await Ticket_1[z(0x1ba)][z(0x1da)]({'where':{'id':d,'tenantId':i},'include':[{'model':Contact_1[A(0x1ba)],'as':A(0x1bf),'include':['extraInfo',A(0x1b9),{'association':z(0x1cf),'attributes':['id',z(0x1bb)]}]},{'model':User_1[z(0x1ba)],'as':z(0x1c5),'attributes':['id','name']},{'association':'whatsapp','attributes':['id',A(0x1bb),'isDeleted']}]});if(!k){if('TVbtY'==='TVbtY')throw new AppError_1[(z(0x1ba))](A(0x1b3),0x194);else throw new d[(z(0x1ba))](z(0x1b3),0x194);}await(0x0,SetTicketMessagesAsRead_1[A(0x1ba)])(k);const l=k[z(0x1b0)]!==z(0x1d7)&&c['status']===A(0x1d7),m=k[A(0x1b0)],n=k['user']?.['id'];m===z(0x1d4)&&await(0x0,CheckContactOpenTickets_1[z(0x1ba)])(k[z(0x1bf)]['id']);const o=g==='close'?'closed':g,p={'status':o,'queueId':j,'userId':h};o===z(0x1d4)&&(p[z(0x1db)]=new Date()[A(0x1bc)]());m===A(0x1d7)&&o==='open'&&(p[z(0x1b8)]=null,p['stepAutoReplyId']=null,p[A(0x1d5)]=new Date()['getTime']());await k['update'](p);m===z(0x1d7)&&o===A(0x1d2)&&await(0x0,CreateLogTicketService_1[A(0x1ba)])({'userId':f,'ticketId':d,'type':'open'});o===z(0x1d4)&&await(0x0,CreateLogTicketService_1['default'])({'userId':f,'ticketId':d,'type':A(0x1d4)});if(m===A(0x1d2)&&o==='pending'){if(A(0x1b7)!==z(0x1b7))return g&&h[z(0x1cd)]?i:{'default':j};else await(0x0,CreateLogTicketService_1[z(0x1ba)])({'userId':f,'ticketId':d,'type':'pending'});}return e&&('hDxDP'===A(0x1d3)?(g[A(0x1b8)]=null,h[A(0x1b4)]=null,i['startedAttendanceAt']=new j()['getTime']()):(await(0x0,CreateLogTicketService_1[z(0x1ba)])({'userId':f,'ticketId':d,'type':A(0x1b1)}),h&&(z(0x1ce)===z(0x1ce)?await(0x0,CreateLogTicketService_1[z(0x1ba)])({'userId':h,'ticketId':d,'type':A(0x1c4)}):(0x0,f['default'])({'tenantId':g,'type':z(0x1be),'payload':h})))),await k['reload'](),e&&await k[z(0x1bd)](z(0x1d6),!![]),l&&(0x0,socketEmit_1[z(0x1ba)])({'tenantId':i,'type':A(0x1be),'payload':k}),(0x0,socketEmit_1[A(0x1ba)])({'tenantId':i,'type':A(0x1b5),'payload':k}),{'ticket':k,'oldStatus':m,'oldUserId':n};};exports['default']=UpdateTicketService;