'use strict';const D=b,E=b;(function(c,d){const A=b,B=b,e=c();while(!![]){try{const f=parseInt(A(0x1f5))/0x1+-parseInt(A(0x1ee))/0x2+parseInt(A(0x215))/0x3*(-parseInt(A(0x226))/0x4)+parseInt(B(0x218))/0x5*(parseInt(B(0x220))/0x6)+parseInt(B(0x1ff))/0x7*(-parseInt(A(0x22a))/0x8)+-parseInt(A(0x1f8))/0x9+parseInt(A(0x22d))/0xa;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x4e68e));var __importDefault=this&&this['__importDefault']||function(c){const C=b;return c&&c[C(0x211)]?c:{'default':c};};function a(){const H=['messenger','QhEJk','default','./CreateLogTicketService','create','value','find','../SettingServices/ListSettingsService','defineProperty','isFarewellMessage','fromMe','isDeleted','__esModule','whatsapp','getWallets','ticket','3hUxVQY','ozpbV','mgJdL','38825gfkNXs','keNLA','waba','./ShowTicketService','sequelize','DESC','DirectTicketsToWallets','../../helpers/CheckChatBotFlowWelcome','258BlDiYp','name','status','KkaSU','wallets','MuKcy','2395768uBGMrU','getTime','extraInfo','isCreated','8NqAsrl','getBodyMessage','key','10481760NBkwRt','ticket:update','telegram','startedAttendanceAt','../../models/CampaignContacts','PboZT','pending','findOne','848544Qrapxn','enabled','../../models/Ticket','contact','unreadMessages','user','../../models/Message','121606IRbMWA','closed','setDataValue','903996OcGkGv','../WbotServices/helpers/VerifyContactBaileys','instagram','open','userId','lastMessage','../../models/User','411971lkalqA','update','body','tags','../../models/Contact','rHSOj'];a=function(){return H;};return a();}Object[D(0x20d)](exports,E(0x211),{'value':!![]});const sequelize_1=require(E(0x21c)),Contact_1=__importDefault(require(D(0x203))),Ticket_1=__importDefault(require(D(0x1f0))),User_1=__importDefault(require(D(0x1fe))),ShowTicketService_1=__importDefault(require(D(0x21b))),CampaignContacts_1=__importDefault(require(D(0x231))),socketEmit_1=__importDefault(require('../../helpers/socketEmit')),CheckChatBotFlowWelcome_1=__importDefault(require(D(0x21f))),CreateLogTicketService_1=__importDefault(require(D(0x208))),Message_1=__importDefault(require(D(0x1f4))),ListSettingsService_1=__importDefault(require(D(0x20c))),VerifyContactBaileys_1=require(E(0x1f9)),FindOrCreateTicketService=async({contact:c,whatsappId:d,unreadMessages:e,tenantId:f,groupContact:g,msg:h,isSync:i,channel:j})=>{const F=E,G=D;let k;j===F(0x1fa)?k=h[F(0x20f)]:k=h['key'][F(0x20f)];if(j===F(0x212)&&h&&k){const p=await CampaignContacts_1[G(0x207)][G(0x1ed)]({'where':{'contactId':c['id'],'messageId':h[G(0x22c)]?.['id']}});if(p?.['id'])return{'isCampaignMessage':!![]};}if(h&&h[G(0x20f)]){const q=await Message_1[G(0x207)]['findOne']({'where':{'messageId':h[G(0x22c)]?.['id']},'include':['ticket']});if(q?.[G(0x214)]?.['status']===F(0x1f6)&&q?.['ticket']['lastMessage']===h[G(0x201)]){if('VQOeq'===F(0x219))e=f[F(0x20f)];else{const s=q[G(0x214)];return s[F(0x20e)]=!![],s;}}}let l=await Ticket_1[G(0x207)][G(0x1ed)]({'where':{'status':{[sequelize_1['Op']['or']]:[G(0x1fb),G(0x1ec)]},'tenantId':f,'whatsappId':d,'contactId':g?g['id']:c['id']},'include':[{'model':Contact_1[G(0x207)],'as':F(0x1f1),'include':[F(0x228),F(0x202),{'association':F(0x224),'attributes':['id','name']}]},{'model':User_1[F(0x207)],'as':F(0x1f3),'attributes':['id',F(0x221)]},{'association':G(0x212),'attributes':['id',F(0x221),F(0x210)]}]});if(l)return e=[G(0x22f),G(0x21a),'instagram',G(0x205)]['includes'](j)&&e>0x0?e+=l[G(0x1f2)]:e,await l['update']({'unreadMessages':e}),(0x0,socketEmit_1[G(0x207)])({'tenantId':f,'type':G(0x22e),'payload':l}),l;if(g){l=await Ticket_1['default']['findOne']({'where':{'contactId':g['id'],'tenantId':f,'whatsappId':d},'order':[['updatedAt',G(0x21d)]],'include':[{'model':Contact_1[G(0x207)],'as':F(0x1f1),'include':[G(0x228),'tags',{'association':G(0x224),'attributes':['id','name']}]},{'model':User_1['default'],'as':G(0x1f3),'attributes':['id',G(0x221)]},{'association':'whatsapp','attributes':['id',F(0x221),F(0x210)]}]});if(l)return G(0x206)!==G(0x206)?g&&h['__esModule']?i:{'default':j}:(await l[G(0x200)]({'status':F(0x1ec),'userId':null,'unreadMessages':e}),(0x0,socketEmit_1[F(0x207)])({'tenantId':f,'type':G(0x22e),'payload':l}),l);}else{if(G(0x223)===G(0x225))e=f[G(0x22c)][F(0x20f)];else{l=await Ticket_1[G(0x207)][G(0x1ed)]({'where':{'status':{[sequelize_1['Op']['in']]:[F(0x1fb),G(0x1ec)]},'tenantId':f,'whatsappId':d,'contactId':c['id']},'order':[['updatedAt','DESC']],'include':[{'model':Contact_1[F(0x207)],'as':G(0x1f1),'include':[F(0x228),G(0x202),{'association':F(0x224),'attributes':['id','name']}]},{'model':User_1[F(0x207)],'as':'user','attributes':['id','name']},{'association':F(0x212),'attributes':['id',G(0x221),F(0x210)]}]});if(l)return await l['update']({'status':'pending','userId':null,'unreadMessages':e}),(0x0,socketEmit_1[F(0x207)])({'tenantId':f,'type':G(0x22e),'payload':l}),l;}}const m=(await(0x0,ListSettingsService_1[F(0x207)])(f))?.[G(0x20b)](v=>v['key']===F(0x21e))?.[G(0x20a)]===F(0x1ef)||![],n={'contactId':g?g['id']:c['id'],'status':F(0x1ec),'isGroup':!!g,'unreadMessages':e,'whatsappId':d,'tenantId':f,'channel':j};if(m&&c['id']){if(G(0x1eb)!==G(0x204)){const v=c,w=await v[F(0x213)]();if(w&&w[0x0]?.['id']){if(F(0x216)===F(0x216))n[F(0x222)]=G(0x1fb),n[G(0x1fc)]=w[0x0]['id'],n[G(0x230)]=new Date()[F(0x227)]();else{const y=d[G(0x214)];return y[F(0x20e)]=!![],y;}}}else return{'isCampaignMessage':!![]};}h&&('mgJdL'===G(0x217)?n[F(0x1fd)]=await(0x0,VerifyContactBaileys_1[G(0x22b)])(h):(h['status']=F(0x1fb),i[G(0x1fc)]=j[0x0]['id'],k[G(0x230)]=new l()[G(0x227)]()));const o=await Ticket_1[G(0x207)][F(0x209)](n);return await(0x0,CreateLogTicketService_1[G(0x207)])({'ticketId':o['id'],'type':G(0x209)}),(h&&!k||!o['userId']||i)&&await(0x0,CheckChatBotFlowWelcome_1['default'])(o),l=await(0x0,ShowTicketService_1[G(0x207)])({'id':o['id'],'tenantId':f}),l[F(0x1f7)](G(0x229),!![]),(0x0,socketEmit_1[F(0x207)])({'tenantId':f,'type':G(0x22e),'payload':l}),l;};function b(c,d){const e=a();return b=function(f,g){f=f-0x1eb;let h=e[f];return h;},b(c,d);}exports['default']=FindOrCreateTicketService;