'use strict';const I=b,J=b;(function(c,d){const G=b,H=b,e=c();while(!![]){try{const f=-parseInt(G(0x123))/0x1*(-parseInt(H(0x11e))/0x2)+-parseInt(G(0x136))/0x3*(-parseInt(H(0x10c))/0x4)+parseInt(H(0x127))/0x5*(-parseInt(H(0x10f))/0x6)+-parseInt(G(0x14d))/0x7*(-parseInt(G(0x11a))/0x8)+parseInt(G(0x134))/0x9*(-parseInt(H(0x103))/0xa)+parseInt(H(0x13c))/0xb+parseInt(G(0xfa))/0xc*(-parseInt(G(0x14a))/0xd);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xa3bb3));function b(c,d){const e=a();return b=function(f,g){f=f-0xc8;let h=e[f];return h;},b(c,d);}var __createBinding=this&&this[I(0xdd)]||(Object[J(0x109)]?function(c,d,e,f){const K=I,L=J;if(f===undefined)f=e;var g=Object[K(0x10d)](d,e);(!g||(L(0xf8)in g?!d['__esModule']:g['writable']||g[K(0x14e)]))&&(g={'enumerable':!![],'get':function(){return d[e];}}),Object[K(0x11c)](c,f,g);}:function(c,d,e,f){if(f===undefined)f=e;c[f]=d[e];}),__setModuleDefault=this&&this[J(0x130)]||(Object['create']?function(c,d){Object['defineProperty'](c,'default',{'enumerable':!![],'value':d});}:function(c,d){const M=I;c[M(0xce)]=d;}),__importStar=this&&this['__importStar']||function(c){const N=J,O=I;if(c&&c[N(0x147)])return c;var d={};if(c!=null){for(var e in c)if(e!==O(0xce)&&Object[N(0xd3)][N(0xf3)][O(0x128)](c,e))__createBinding(d,c,e);}return __setModuleDefault(d,c),d;},__importDefault=this&&this['__importDefault']||function(c){const P=J;return c&&c[P(0x147)]?c:{'default':c};};Object['defineProperty'](exports,I(0x147),{'value':!![]}),exports[I(0x12b)]=void 0x0;function a(){const aa=['../../utils/logger','contextInfo','whatsapp','count','WAMessageStubType','LSfZk','QueryTypes','now','receiptTimestamp','add','length','VerifyContactBaileys','../../helpers/socketEmit','lYaKH','filter','NrSvf','./helpers/VerifyContactBaileys','status','../QueueServices/GetQueueService','hasOwnProperty','isCampaignMessage','imageMessage','YVrou','queueId','get','profilePictureUrl','4246224fcNonm','map','findOne','contact','./../../database/index','remoteJid','stickerMessage','readTimestamp','dIVjp','216740eTDeYt','broadcast','wNIhr','HZrhr','quotedMsg','FSDVV','create','cacheLayer','CIPHERTEXT','1612700eCpyIE','getOwnPropertyDescriptor','message','7120092zAMoNE','./helpers/IsValidMsg','OyUzj','protocolMessage','isFarewellMessage','query','../WhatsappService/ShowWhatsAppService','../../models/Ticket','indexOf','\x20and\x20c.\x22number\x22\x20=\x20\x27','urlMessageStatus','5024jCqdUa','TfsCD','defineProperty','messages.update','9486xVvNJn','GVogj','split','select\x20t.id,\x20t.\x22lastMessage\x22,\x20c.\x22number\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x20t,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22Contacts\x22\x20c\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20t.\x22tenantId\x22\x20=\x20','../../models/CampaignContacts','241EkFmlL','isGroup','contacts:','messageStubType','5UwsPxc','call','fromMe','WebHooksAPI','wbotMessageListenerBaileys','E2E_IDENTITY_CHANGED','answered','apiConfig','key','__setModuleDefault','videoMessage','participant','value','261RowNXS','eauNo','3veZLvN','image','receipt','\x27\x20and\x20c.\x22tenantId\x22\x20=\x20','documentMessage','error','8494123mGFQWQ','logger','@g.us','sQOMa','qEIny','extendedTextMessage','groupMetadata','../ChatFlowServices/VerifyStepsChatFlowTicket','../TicketServices/FindOrCreateTicketService','yQeIS','tenantId','__esModule','set','chat:ack','39fjoSOd','externalKey','sequelize','13699FIjWYj','configurable','SELECT','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20c.\x22number\x22\x20=\x20\x27','../../models/Setting','captureException','quotedMessage','getBodyMessage','default','forEach','E2E_DEVICE_CHANGED','enabled','Error\x20handling\x20message\x20ack.\x20Err:\x20','prototype','../../libs/Queue','shift','../OpenIA/VerifyMensageOpenIAQueue','Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20','VerifyMediaMessageBaileys','message-receipt.update','ticket','update',':unreads','__createBinding','documentWithCaptionMessage','qrAMV'];a=function(){return aa;};return a();}const baileys_1=require('@whiskeysockets/baileys'),Message_1=__importDefault(require('../../models/Message')),Sentry=__importStar(require('@sentry/node')),logger_1=require(J(0xe0)),Ticket_1=__importDefault(require(J(0x116))),IsValidMsg_1=require(I(0x110)),ShowWhatsAppService_1=__importDefault(require(I(0x115))),Setting_1=__importDefault(require(I(0xca))),FindOrCreateTicketService_1=__importDefault(require(J(0x144))),VerifyContactBaileys_1=require(J(0xf0)),Queue_1=__importDefault(require(J(0xd4))),VerifyBusinessHours_1=__importDefault(require('./helpers/VerifyBusinessHours')),VerifyStepsChatFlowTicket_1=__importDefault(require(I(0x143))),socketEmit_1=__importDefault(require(I(0xec))),index_1=__importDefault(require(I(0xfe))),sequelize_1=require(J(0x14c)),CampaignContacts_1=__importDefault(require(J(0x122))),cache_1=require('../../libs/cache'),GetQueueService_1=__importDefault(require(J(0xf2))),VerifyMensageOpenIAQueue_1=__importDefault(require(I(0xd6))),messageQueue=[],filterMessages=c=>{const Q=I,R=I;if(c[Q(0x10e)]?.[Q(0x112)])return![];if([baileys_1[Q(0xe4)]['REVOKE'],baileys_1[R(0xe4)][Q(0xd0)],baileys_1[R(0xe4)][R(0x12c)],baileys_1['WAMessageStubType'][Q(0x10b)]]['includes'](c[R(0x126)]))return![];return!![];},wbotMessageListenerBaileys=async(c,d)=>{const U=I,Y=J;try{c['ev']['on']('messages.upsert',async e=>{const S=b,T=b,f=e['messages'][S(0xee)](filterMessages)[S(0xfb)](g=>g);if(!f)return;for(let g of f){if('NrSvf'!==T(0xef))return;else{const i=g['key'][T(0xff)][S(0x120)]('@')[0x0],j=S(0x121)+d[S(0x146)]+S(0xc9)+i+'\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20c.\x22tenantId\x22\x20=\x20'+d['tenantId']+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20t.\x22contactId\x22\x20=\x20c.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20t.id\x20=\x20(select\x20max(id)\x20from\x20\x22Tickets\x22\x20where\x20t.\x22tenantId\x22\x20=\x20'+d['tenantId']+S(0x118)+i+S(0x139)+d[T(0x146)]+')',k=await index_1[T(0xce)]?.[S(0x114)](j,{'type':sequelize_1[S(0xe6)][S(0xc8)],'nest':!![]});if(k[S(0xea)]>0x0&&g[S(0x12f)]['fromMe']&&k[0x0]['lastMessage']===d['farewellMessage'])return;const l=await CampaignContacts_1[T(0xce)]['count']({'where':{'messageId':g[T(0x12f)]['id']}});if(l>0x0)return;const m=await Message_1['default'][T(0xe3)]({'where':{'messageId':g[T(0x12f)]['id'],'tenantId':d[S(0x146)]}});if(!m){const n=await(0x0,VerifyContactBaileys_1[S(0xcd)])(g),o=/\u200c/['test'](n);!o&&await handleMessageBaileys(c,g,d['id']);}else g[T(0x12f)]['fromMe']&&await Message_1[S(0xce)][S(0xdb)]({'dataJson':JSON['stringify'](g)},{'where':{'messageId':g[T(0x12f)]['id'],'tenantId':d[T(0x146)]}});}}}),c['ev']['on'](U(0x11d),e=>{const V=U;if(e[V(0xea)]===0x0)return;e['forEach'](async f=>{const W=V,X=V;if('GVogj'===W(0x11f)){let g;f[W(0xdb)][X(0xf1)]===0x3&&f?.[X(0x12f)]?.[X(0x129)]?g=0x2:g=f['update']['status'],handleMsgAckBaileys(f,g);}else d=0x2;});}),c['ev']['on'](U(0xd9),e=>{const Z=U;e[Z(0xcf)](async f=>{const a0=Z,a1=Z;if('UXbgY'==='NXazA'){const h={'timestamp':k['now'](),'msg':l,'messageId':m['key']['id'],'ticketId':n['id'],'externalKey':o?.[a0(0x14b)],'authToken':p?.['authToken'],'type':'hookMessage'};q['default'][a1(0xe9)](a0(0x12a),{'url':r[a0(0x119)],'type':h['type'],'payload':h});}else{const h=f?.[a1(0x138)]?.[a1(0xe8)]?0x3:f?.['receipt']?.[a1(0x101)]?0x4:0x0;if(!h)return;await handleMsgAckBaileys(f,h);}});});}catch(e){if(U(0xf6)===Y(0xdf))return;else Sentry[Y(0xcb)](e),logger_1[U(0x13d)][U(0x13b)](U(0xd7)+e);}};exports[I(0x12b)]=wbotMessageListenerBaileys;const handleReceiveMessages=async()=>{const a2=J,a3=J;while(messageQueue[a2(0xea)]>0x0){const {message:c,wbot:d,whatsapp:e}=messageQueue[0x0];messageQueue[a2(0xd5)]();}},handleMsgAckBaileys=async(c,d)=>{const a4=J,a5=J;await new Promise(e=>setTimeout(e,0x1f4));try{if(a4(0x105)===a5(0x105)){const e=await Message_1[a5(0xce)][a4(0xfc)]({'where':{'messageId':String(c['key']['id'])},'include':[a5(0xfd),{'model':Ticket_1['default'],'as':a4(0xda)},{'model':Message_1[a5(0xce)],'as':a4(0x107),'include':['contact']}]});if(!e){if(a4(0x111)!==a5(0x111))return g&&h[a4(0x147)]?i:{'default':j};else{const g=await CampaignContacts_1[a4(0xce)][a4(0xfc)]({'where':{'messageId':String(c['key']['id'])}});if(!g)return;await g[a5(0xdb)]({'ack':d});return;}}await e[a4(0xdb)]({'ack':d}),(0x0,socketEmit_1[a4(0xce)])({'tenantId':e['tenantId'],'type':a5(0x149),'payload':e});}else return;}catch(i){a4(0x108)===a5(0x135)?e[a5(0x13d)][a5(0x13b)](f):(Sentry[a4(0xcb)](i),logger_1[a5(0x13d)][a4(0x13b)](a4(0xd2)+i));}},handleMessageBaileys=async(c,d,f)=>{const a6=J,a7=I;if(!(0x0,IsValidMsg_1['isValidBaileys'])(d)){if('sQOMa'===a6(0x13f))return;else return d[a6(0x12f)][a7(0xff)]?.[a6(0x117)](a7(0x13e))>0x0;}const g=await(0x0,ShowWhatsAppService_1['default'])({'id':f}),{tenantId:h,isDeleted:i}=g;if(i)return;const j=await Setting_1[a6(0xce)]['findOne']({'where':{'key':'ignoreGroupMsg','tenantId':h}});if(j?.[a7(0x133)]===a7(0xd1)&&(isGroup(d)||d[a6(0x104)])){if(a7(0x106)!==a7(0x106))return;else return;}try{if(a6(0xe5)==='LSfZk'){let m,n,o;if(!d['key'][a6(0x129)]){if(a7(0x145)!=='yQeIS')return;else try{n=await c[a7(0xf9)](d[a7(0x12f)][a6(0xff)],a6(0x137),0x7530);}catch(v){n=null;}}let p={};isGroup(d)&&(p=await c[a7(0x142)](d[a7(0x12f)][a7(0xff)]),m=await(0x0,VerifyContactBaileys_1['VerifyContactBaileys'])(d,h,n,!![],p));if(!d[a7(0x12f)]['fromMe'])try{d[a7(0x12f)][a6(0x132)]?'otDsu'!=='HLPgl'?n=await c['profilePictureUrl'](d[a7(0x12f)]['participant'],a7(0x137),0x7530):f['defineProperty'](g,a6(0xce),{'enumerable':!![],'value':h}):n=await c[a6(0xf9)](d[a7(0x12f)][a6(0xff)],a7(0x137),0x7530);}catch(x){n=null;}o=await(0x0,VerifyContactBaileys_1[a6(0xeb)])(d,h,n,![],p);let q=0x0;if(d[a6(0x12f)][a6(0x129)])await cache_1[a7(0x10a)][a7(0x148)](a6(0x125)+o['id']+':unreads','0');else{const y=await cache_1['cacheLayer']['get']('contacts:'+o['id']+':unreads');q=+y+0x1,await cache_1[a7(0x10a)][a7(0x148)](a7(0x125)+o['id']+a6(0xdc),''+q);}const r=await(0x0,FindOrCreateTicketService_1[a6(0xce)])({'contact':o,'whatsappId':f,'unreadMessages':q,'tenantId':h,'groupContact':m,'msg':d,'channel':a6(0xe2)});if(r?.[a6(0xf4)])return;if(r?.[a6(0x113)]){if(a7(0x11b)===a6(0x102))return;else return;}d[a6(0x10e)]?.[a7(0xf5)]||d[a7(0x10e)]?.['audioMessage']||d[a7(0x10e)]?.[a7(0x131)]||d[a6(0x10e)]?.[a7(0x100)]||d[a6(0x10e)]?.[a6(0x13a)]||d[a6(0x10e)]?.[a7(0xde)]?.[a7(0x10e)]?.[a6(0x13a)]||d[a6(0x10e)]?.[a7(0x141)]?.[a6(0xe1)]?.[a7(0xcc)]?.['imageMessage']||d[a7(0x10e)]?.[a7(0x141)]?.['contextInfo']?.[a6(0xcc)]?.['videoMessage']?await(0x0,VerifyContactBaileys_1[a6(0xd8)])(d,r,o):await(0x0,VerifyContactBaileys_1['VerifyMessageBaileys'])(d,d[a7(0x12f)][a6(0x129)],r,o);const s=await(0x0,VerifyBusinessHours_1[a6(0xce)])(d,r);if(s)await(0x0,VerifyStepsChatFlowTicket_1[a7(0xce)])(d,r);if(s&&r[a7(0xf7)]&&r['is_chat_ia']){if(a7(0xed)!=='fqZHR'){const A=await(0x0,GetQueueService_1[a7(0xce)])(r[a7(0xf7)]);await(0x0,VerifyMensageOpenIAQueue_1[a6(0xce)])(r,A,![],!![],d[a6(0x12f)],d);}else e=f[a7(0xdb)][a7(0xf1)];}const t=r[a7(0x12e)]||{};if(!d['key'][a6(0x129)]&&!r[a7(0x124)]&&!r[a6(0x12d)]&&t?.[a6(0x14b)]&&t?.['urlMessageStatus']){const C={'timestamp':Date[a7(0xe7)](),'msg':d,'messageId':d['key']['id'],'ticketId':r['id'],'externalKey':t?.[a7(0x14b)],'authToken':t?.['authToken'],'type':'hookMessage'};Queue_1[a7(0xce)][a6(0xe9)]('WebHooksAPI',{'url':t['urlMessageStatus'],'type':C['type'],'payload':C});}}else e[a7(0xce)]=f;}catch(E){if(a6(0x140)!==a7(0x140)){if(k===l)m=n;o[p]=q[r];}else logger_1['logger'][a7(0x13b)](E);}},isGroup=c=>{const a8=J,a9=I;return c[a8(0x12f)][a8(0xff)]?.[a9(0x117)](a8(0x13e))>0x0;};