'use strict';const I=b,J=b;function a(){const ac=['findOne','VerifyMessageBaileys','call','chat:ack','default','../../models/Ticket','get','\x27\x20and\x20c.\x22tenantId\x22\x20=\x20','contacts:','select\x20t.id,\x20t.\x22lastMessage\x22,\x20c.\x22number\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x20t,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22Contacts\x22\x20c\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20t.\x22tenantId\x22\x20=\x20','map','PzFtF','QueryTypes','receiptTimestamp','13654368ADJkGJ','lastMessage','messages.upsert','sXjDa','broadcast','answered','documentWithCaptionMessage','2448042hBbVJf','readTimestamp','ticket','profilePictureUrl','create','kKNrN','audioMessage','urlMessageStatus','55NONhum','key','tenantId','14940702Jjezyh','__setModuleDefault','@sentry/node','configurable','SELECT','receipt','fromMe','hasOwnProperty','status','../../models/CampaignContacts','messages','./helpers/IsValidMsg','split','VerifyMediaMessageBaileys','test','message','\x20and\x20c.\x22number\x22\x20=\x20\x27','4tChWRl','./../../database/index','participant','isGroup','getBodyMessage','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20c.\x22number\x22\x20=\x20\x27','../../models/Setting','../../utils/logger','../../helpers/socketEmit','sequelize','../OpenIA/VerifyMensageOpenIAQueue','captureException','8zHOKRY','videoMessage','queueId','includes','__esModule','groupMetadata','55qgUBLx','isFarewellMessage','@whiskeysockets/baileys','497034ALtLeC','./helpers/VerifyBusinessHours','quotedMsg','defineProperty','cacheLayer','OHBhe','remoteJid','WAMessageStubType','type','kXwxH','length','message-receipt.update','is_chat_ia','../../models/Message','../ChatFlowServices/VerifyStepsChatFlowTicket','update','694123CdwGAZ','query','E2E_IDENTITY_CHANGED','value','isCampaignMessage','quotedMessage','stringify','E2E_DEVICE_CHANGED','../../libs/Queue','2008010zmqpMd','imageMessage','hookMessage','VDbtJ','enabled','shift','VerifyContactBaileys','writable','../WhatsappService/ShowWhatsAppService','logger','error','forEach','ignoreGroupMsg','4882336yIpQGj','stickerMessage','getOwnPropertyDescriptor','contextInfo','xfTFV','apiConfig','documentMessage','prototype','Error\x20handling\x20message\x20ack.\x20Err:\x20','wbotMessageListenerBaileys','__importStar','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20c.\x22tenantId\x22\x20=\x20','extendedTextMessage',':unreads','jqUtB','count','__importDefault','@g.us','__createBinding','messageStubType','../TicketServices/FindOrCreateTicketService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20t.\x22contactId\x22\x20=\x20c.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20t.id\x20=\x20(select\x20max(id)\x20from\x20\x22Tickets\x22\x20where\x20t.\x22tenantId\x22\x20=\x20','externalKey','REVOKE','ehQvT','now','image'];a=function(){return ac;};return a();}(function(c,d){const G=b,H=b,e=c();while(!![]){try{const f=-parseInt(G(0x1b3))/0x1*(-parseInt(H(0x18e))/0x2)+-parseInt(H(0x172))/0x3+-parseInt(H(0x1c9))/0x4+-parseInt(G(0x17a))/0x5*(-parseInt(G(0x1a3))/0x6)+-parseInt(G(0x16b))/0x7+-parseInt(H(0x19a))/0x8*(-parseInt(H(0x17d))/0x9)+parseInt(G(0x1bc))/0xa*(parseInt(G(0x1a0))/0xb);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xee5d0));function b(c,d){const e=a();return b=function(f,g){f=f-0x146;let h=e[f];return h;},b(c,d);}var __createBinding=this&&this[I(0x154)]||(Object[J(0x176)]?function(c,d,e,f){const K=I,L=I;if(f===undefined)f=e;var g=Object[K(0x1cb)](d,e);(!g||(K(0x163)in g?!d[L(0x19e)]:g[L(0x1c3)]||g[L(0x180)]))&&(g={'enumerable':!![],'get':function(){return d[e];}}),Object[L(0x1a6)](c,f,g);}:function(c,d,e,f){if(f===undefined)f=e;c[f]=d[e];}),__setModuleDefault=this&&this[I(0x17e)]||(Object[I(0x176)]?function(c,d){const M=I;Object['defineProperty'](c,M(0x161),{'enumerable':!![],'value':d});}:function(c,d){const N=I;c[N(0x161)]=d;}),__importStar=this&&this[I(0x14c)]||function(c){const O=I,P=J;if(c&&c['__esModule'])return c;var d={};if(c!=null){for(var e in c)if(e!==O(0x161)&&Object[O(0x149)][O(0x184)][P(0x15f)](c,e))__createBinding(d,c,e);}return __setModuleDefault(d,c),d;},__importDefault=this&&this[I(0x152)]||function(c){const Q=I;return c&&c[Q(0x19e)]?c:{'default':c};};Object[I(0x1a6)](exports,I(0x19e),{'value':!![]}),exports['wbotMessageListenerBaileys']=void 0x0;const baileys_1=require(I(0x1a2)),Message_1=__importDefault(require(I(0x1b0))),Sentry=__importStar(require(J(0x17f))),logger_1=require(I(0x195)),Ticket_1=__importDefault(require(J(0x162))),IsValidMsg_1=require(I(0x188)),ShowWhatsAppService_1=__importDefault(require(I(0x1c4))),Setting_1=__importDefault(require(J(0x194))),FindOrCreateTicketService_1=__importDefault(require(I(0x156))),VerifyContactBaileys_1=require('./helpers/VerifyContactBaileys'),Queue_1=__importDefault(require(I(0x1bb))),VerifyBusinessHours_1=__importDefault(require(I(0x1a4))),VerifyStepsChatFlowTicket_1=__importDefault(require(J(0x1b1))),socketEmit_1=__importDefault(require(I(0x196))),index_1=__importDefault(require(J(0x18f))),sequelize_1=require(I(0x197)),CampaignContacts_1=__importDefault(require(J(0x186))),cache_1=require('../../libs/cache'),GetQueueService_1=__importDefault(require('../QueueServices/GetQueueService')),VerifyMensageOpenIAQueue_1=__importDefault(require(I(0x198))),messageQueue=[],filterMessages=c=>{const R=I,S=J;if(c['message']?.['protocolMessage'])return![];if([baileys_1[R(0x1aa)][S(0x159)],baileys_1[S(0x1aa)][R(0x1ba)],baileys_1['WAMessageStubType'][R(0x1b5)],baileys_1[R(0x1aa)]['CIPHERTEXT']][R(0x19d)](c[R(0x155)]))return![];return!![];},wbotMessageListenerBaileys=async(c,d)=>{const T=J,a0=J;try{c['ev']['on'](T(0x16d),async e=>{const U=T,V=T,f=e[U(0x187)]['filter'](filterMessages)[V(0x167)](g=>g);if(!f)return;for(let g of f){const h=g[V(0x17b)][V(0x1a9)][V(0x189)]('@')[0x0],i=V(0x166)+d[V(0x17c)]+U(0x193)+h+V(0x14d)+d['tenantId']+V(0x157)+d[V(0x17c)]+U(0x18d)+h+V(0x164)+d[V(0x17c)]+')',j=await index_1[V(0x161)]?.[U(0x1b4)](i,{'type':sequelize_1[V(0x169)][U(0x181)],'nest':!![]});if(j[U(0x1ad)]>0x0&&g[U(0x17b)][V(0x183)]&&j[0x0][V(0x16c)]===d['farewellMessage'])return;const k=await CampaignContacts_1[V(0x161)][V(0x151)]({'where':{'messageId':g[V(0x17b)]['id']}});if(k>0x0)return;const l=await Message_1['default'][V(0x151)]({'where':{'messageId':g[V(0x17b)]['id'],'tenantId':d[V(0x17c)]}});if(!l){const m=await(0x0,VerifyContactBaileys_1[U(0x192)])(g),n=/\u200c/[U(0x18b)](m);if(!n){if(U(0x15a)!=='FrhHd')await handleMessageBaileys(c,g,d['id']);else return;}}else g[U(0x17b)][U(0x183)]&&await Message_1[U(0x161)][U(0x1b2)]({'dataJson':JSON[U(0x1b9)](g)},{'where':{'messageId':g['key']['id'],'tenantId':d['tenantId']}});}}),c['ev']['on']('messages.update',e=>{const W=T,X=T;if(W(0x1a8)!==X(0x1a8))return;else{if(e[W(0x1ad)]===0x0)return;e[W(0x1c7)](async g=>{const Y=X,Z=X;if('WlhiB'!==Y(0x168)){let h;g[Z(0x1b2)][Y(0x185)]===0x3&&g?.['key']?.[Y(0x183)]?h=0x2:h=g[Z(0x1b2)][Y(0x185)],handleMsgAckBaileys(g,h);}else return;});}}),c['ev']['on'](a0(0x1ae),e=>{const a1=a0;e[a1(0x1c7)](async f=>{const a2=a1,a3=a1,g=f?.[a2(0x182)]?.[a2(0x16a)]?0x3:f?.['receipt']?.[a2(0x173)]?0x4:0x0;if(!g)return;await handleMsgAckBaileys(f,g);});});}catch(e){Sentry[a0(0x199)](e),logger_1[T(0x1c5)][a0(0x1c6)]('Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20'+e);}};exports[J(0x14b)]=wbotMessageListenerBaileys;const handleReceiveMessages=async()=>{const a4=I,a5=I;while(messageQueue['length']>0x0){if('SYUAO'!=='pvuUs'){const {message:c,wbot:d,whatsapp:e}=messageQueue[0x0];messageQueue[a4(0x1c1)]();}else f[a4(0x1a6)](g,'default',{'enumerable':!![],'value':h});}},handleMsgAckBaileys=async(c,d)=>{const a6=I,a7=J;await new Promise(e=>setTimeout(e,0x1f4));try{const e=await Message_1[a6(0x161)][a6(0x15d)]({'where':{'messageId':String(c['key']['id'])},'include':['contact',{'model':Ticket_1['default'],'as':a7(0x174)},{'model':Message_1[a7(0x161)],'as':a7(0x1a5),'include':['contact']}]});if(!e){const f=await CampaignContacts_1[a6(0x161)][a7(0x15d)]({'where':{'messageId':String(c[a6(0x17b)]['id'])}});if(!f){if(a7(0x150)!=='yzgek')return;else return;}await f[a7(0x1b2)]({'ack':d});return;}await e[a6(0x1b2)]({'ack':d}),(0x0,socketEmit_1['default'])({'tenantId':e['tenantId'],'type':a6(0x160),'payload':e});}catch(h){Sentry[a7(0x199)](h),logger_1[a6(0x1c5)]['error']('Error\x20handling\x20message\x20ack.\x20Err:\x20'+h);}},handleMessageBaileys=async(c,d,f)=>{const a8=I,a9=J;if(!(0x0,IsValidMsg_1['isValidBaileys'])(d))return;const g=await(0x0,ShowWhatsAppService_1[a8(0x161)])({'id':f}),{tenantId:h,isDeleted:i}=g;if(i)return;const j=await Setting_1[a8(0x161)][a8(0x15d)]({'where':{'key':a9(0x1c8),'tenantId':h}});if(j?.[a8(0x1b6)]===a8(0x1c0)&&(isGroup(d)||d[a9(0x16f)]))return;try{let k,l,m;if(!d[a9(0x17b)]['fromMe'])try{l=await c[a8(0x175)](d[a9(0x17b)]['remoteJid'],a8(0x15c),0x7530);}catch(s){a9(0x1ac)===a9(0x1ac)?l=null:d=null;}let n={};isGroup(d)&&(n=await c[a8(0x19f)](d[a9(0x17b)]['remoteJid']),k=await(0x0,VerifyContactBaileys_1[a9(0x1c2)])(d,h,l,!![],n));if(!d[a8(0x17b)][a9(0x183)])try{if(d['key'][a9(0x190)]){if('IOuvd'==='TUwnx')return;else l=await c[a8(0x175)](d['key'][a9(0x190)],'image',0x7530);}else l=await c[a9(0x175)](d['key']['remoteJid'],'image',0x7530);}catch(v){l=null;}m=await(0x0,VerifyContactBaileys_1[a8(0x1c2)])(d,h,l,![],n);let o=0x0;if(d[a8(0x17b)][a8(0x183)]){if(a8(0x146)==='VFxyi'){if(p===q)r=s;var x=t[a8(0x1cb)](u,v);(!x||(a8(0x163)in x?!w[a9(0x19e)]:x[a9(0x1c3)]||x['configurable']))&&(x={'enumerable':!![],'get':function(){return x[F];}}),z[a9(0x1a6)](A,B,x);}else await cache_1['cacheLayer']['set'](a8(0x165)+m['id']+a8(0x14f),'0');}else{const x=await cache_1['cacheLayer'][a9(0x163)](a8(0x165)+m['id']+a9(0x14f));o=+x+0x1,await cache_1[a8(0x1a7)]['set'](a8(0x165)+m['id']+a9(0x14f),''+o);}const p=await(0x0,FindOrCreateTicketService_1[a8(0x161)])({'contact':m,'whatsappId':f,'unreadMessages':o,'tenantId':h,'groupContact':k,'msg':d,'channel':'whatsapp'});if(p?.[a9(0x1b7)]){if(a8(0x1bf)!==a9(0x177))return;else g[a8(0x199)](h),i[a9(0x1c5)][a8(0x1c6)](a9(0x14a)+j);}if(p?.[a9(0x1a1)])return;d[a8(0x18c)]?.['imageMessage']||d[a9(0x18c)]?.[a9(0x178)]||d[a9(0x18c)]?.[a8(0x19b)]||d[a8(0x18c)]?.[a8(0x1ca)]||d[a8(0x18c)]?.[a8(0x148)]||d[a8(0x18c)]?.[a8(0x171)]?.[a8(0x18c)]?.[a9(0x148)]||d[a9(0x18c)]?.[a9(0x14e)]?.[a9(0x1cc)]?.[a9(0x1b8)]?.[a9(0x1bd)]||d[a9(0x18c)]?.[a9(0x14e)]?.[a8(0x1cc)]?.['quotedMessage']?.[a9(0x19b)]?await(0x0,VerifyContactBaileys_1[a8(0x18a)])(d,p,m):await(0x0,VerifyContactBaileys_1[a8(0x15e)])(d,d[a8(0x17b)][a8(0x183)],p,m);const q=await(0x0,VerifyBusinessHours_1[a8(0x161)])(d,p);if(q)await(0x0,VerifyStepsChatFlowTicket_1[a9(0x161)])(d,p);if(q&&p[a8(0x19c)]&&p[a8(0x1af)]){const z=await(0x0,GetQueueService_1['default'])(p['queueId']);await(0x0,VerifyMensageOpenIAQueue_1[a8(0x161)])(p,z,![],!![],d[a9(0x17b)],d);}const r=p[a8(0x147)]||{};if(!d[a8(0x17b)][a8(0x183)]&&!p[a9(0x191)]&&!p[a9(0x170)]&&r?.[a9(0x158)]&&r?.[a9(0x179)]){const A={'timestamp':Date[a9(0x15b)](),'msg':d,'messageId':d[a8(0x17b)]['id'],'ticketId':p['id'],'externalKey':r?.[a8(0x158)],'authToken':r?.['authToken'],'type':a9(0x1be)};Queue_1[a9(0x161)]['add']('WebHooksAPI',{'url':r[a8(0x179)],'type':A[a8(0x1ab)],'payload':A});}}catch(B){if(a8(0x16e)!=='dylET')logger_1[a9(0x1c5)][a8(0x1c6)](B);else while(f['length']>0x0){const {message:D,wbot:E,whatsapp:F}=i[0x0];j['shift']();}}},isGroup=c=>{const aa=I,ab=I;return c[aa(0x17b)][ab(0x1a9)]?.['indexOf'](ab(0x153))>0x0;};