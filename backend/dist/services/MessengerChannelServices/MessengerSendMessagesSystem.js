'use strict';const y=b,A=b;(function(c,d){const w=b,x=b,e=c();while(!![]){try{const f=parseInt(w(0x183))/0x1*(parseInt(x(0x186))/0x2)+parseInt(w(0x15c))/0x3+-parseInt(w(0x160))/0x4*(parseInt(w(0x164))/0x5)+-parseInt(w(0x142))/0x6+parseInt(x(0x180))/0x7*(-parseInt(x(0x17d))/0x8)+-parseInt(x(0x146))/0x9*(-parseInt(w(0x163))/0xa)+-parseInt(x(0x15f))/0xb*(-parseInt(w(0x144))/0xc);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x2f899));var __importDefault=this&&this[y(0x14a)]||function(c){const z=y;return c&&c[z(0x187)]?c:{'default':c};};Object[y(0x188)](exports,y(0x187),{'value':!![]});const promises_1=require('fs/promises'),fluent_ffmpeg_1=__importDefault(require('fluent-ffmpeg')),path_1=require(y(0x179)),sequelize_1=require(A(0x185)),sharp_1=__importDefault(require(A(0x16c))),socketEmit_1=__importDefault(require(y(0x14d))),Message_1=__importDefault(require(A(0x161))),Ticket_1=__importDefault(require('../../models/Ticket')),logger_1=require(A(0x152)),sleepRandomTime_1=require(y(0x175)),MessengerSendMessagesSystem=async(c,d)=>{const B=y,C=A,e={'fromMe':!![],'messageId':{[sequelize_1['Op']['is']]:null},'status':B(0x16b),[sequelize_1['Op']['or']]:[{'scheduleDate':{[sequelize_1['Op'][C(0x143)]]:new Date()}},{'scheduleDate':{[sequelize_1['Op']['is']]:null}}]},f=await Message_1[C(0x154)]['findAll']({'where':e,'include':[B(0x15b),{'model':Ticket_1['default'],'as':C(0x150),'where':{'tenantId':d,[sequelize_1['Op']['or']]:{'status':{[sequelize_1['Op']['ne']]:'closed'},'isFarewellMessage':!![]},'channel':B(0x17a),'whatsappId':c['id']},'include':[B(0x15b)]},{'model':Message_1['default'],'as':B(0x159),'include':[C(0x15b)]}],'order':[[B(0x171),C(0x172)]]});let g;for(const h of f){const i=h,{ticket:j}=i,k=j[C(0x15b)][B(0x177)];try{if(![C(0x174),B(0x16e)][C(0x182)](i['mediaType'])&&i['mediaName']){const m=(0x0,path_1[B(0x157)])(__dirname,'..','..','..',C(0x16a)),n=(0x0,path_1[B(0x157)])(m,i[B(0x166)]),o=await(0x0,promises_1['readFile'])(n);console[C(0x158)](n);if(i[C(0x162)]===B(0x156)||i['mediaType']==='ptt'){const p=i[C(0x166)][C(0x17f)]('.'),q=(0x0,path_1[B(0x157)])(m,p[0x0]+'.mp4');await new Promise((s,t)=>{const D=B,E=C;(0x0,fluent_ffmpeg_1['default'])(n)[D(0x155)](D(0x176))['on'](E(0x173),u=>t(u))['on'](E(0x148),()=>s(!![]))[E(0x170)](q);});const r=await(0x0,promises_1[C(0x153)])(q);g=await c[C(0x14e)](k,r);}if(i[C(0x162)]===C(0x181)){const s=await(0x0,sharp_1[B(0x154)])(o)[C(0x17c)]()['toBuffer']();g=await c[C(0x147)](k,s,{'filename':i[C(0x166)]});}i[C(0x162)]===B(0x149)&&(g=await c['sendVideo'](k,o,{'filename':i['mediaName']})),[B(0x178),C(0x17e),C(0x16f)][B(0x182)](i[B(0x162)])&&(g=await c[C(0x184)](k,o,{'filename':i['mediaName']}));}[C(0x174),C(0x16e)][B(0x182)](i[B(0x162)])&&!i['mediaName']&&(g=await c[C(0x145)](k,i[C(0x165)]));const l={...i,...g,'id':i['id'],'timestamp':i[C(0x168)],'messageId':g[C(0x167)],'status':C(0x15e),'ack':0x2};await Message_1[C(0x154)][C(0x14c)]({...l},{'where':{'id':i['id']}}),(0x0,socketEmit_1[C(0x154)])({'tenantId':j[C(0x15a)],'type':C(0x141),'payload':{...i['dataValues'],'mediaUrl':i['mediaUrl'],'id':i['id'],'timestamp':i[C(0x168)],'messageId':g[B(0x167)],'status':C(0x15e),'ack':0x2}}),logger_1['logger'][C(0x169)](B(0x16d)),await(0x0,sleepRandomTime_1['sleepRandomTime'])({'minMilliseconds':Number(0x1f4),'maxMilliseconds':Number(0x5dc)});}catch(t){const u=i['id'],v=i[C(0x150)]['id'];logger_1[C(0x17b)][C(0x173)](C(0x15d)+d+B(0x14f)+v+')'),logger_1['logger'][B(0x173)](C(0x151)+u+C(0x14b)+t);}}};function a(){const F=['messageId','timestamp','info','public','pending','sharp','Message\x20Update\x20ok','text','document','saveToFile','createdAt','ASC','error','chat','../../utils/sleepRandomTime','mp4','messengerId','application','path','messenger','logger','jpeg','8FsAQPi','file','split','1412971iurgAK','image','includes','157417fThXBd','sendFile','sequelize','4FKwmTM','__esModule','defineProperty','chat:ack','886716ErUEPl','lte','871932WbtPXx','sendText','108dIXeBK','sendImage','end','video','__importDefault',')::\x20','update','../../helpers/socketEmit','sendAudio','\x20|\x20Ticket:\x20','ticket','Error\x20send\x20message\x20(id:\x20','../../utils/logger','readFile','default','toFormat','audio','join','log','quotedMsg','tenantId','contact','244821XClMMm','Error\x20message\x20is\x20(tenant:\x20','sended','77oeMcRW','1446512NdlzCP','../../models/Message','mediaType','760OLdUip','5qnSTmS','body','mediaName'];a=function(){return F;};return a();}function b(c,d){const e=a();return b=function(f,g){f=f-0x141;let h=e[f];return h;},b(c,d);}exports[y(0x154)]=MessengerSendMessagesSystem;