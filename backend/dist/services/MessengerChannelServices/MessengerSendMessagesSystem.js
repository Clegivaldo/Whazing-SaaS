'use strict';const y=b,A=b;(function(c,d){const w=b,x=b,e=c();while(!![]){try{const f=-parseInt(w(0x1a2))/0x1*(parseInt(w(0x19d))/0x2)+parseInt(w(0x175))/0x3+-parseInt(w(0x1ae))/0x4*(parseInt(w(0x181))/0x5)+parseInt(x(0x18c))/0x6*(parseInt(w(0x1b2))/0x7)+-parseInt(x(0x1a1))/0x8+parseInt(w(0x17a))/0x9*(parseInt(x(0x17f))/0xa)+-parseInt(x(0x199))/0xb;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x44804));var __importDefault=this&&this[y(0x183)]||function(c){const z=y;return c&&c[z(0x187)]?c:{'default':c};};function a(){const F=['saveToFile','sequelize','lte','end','findAll','sended','readFile','messengerId','defineProperty','document','4fCKnBP','default','pending','quotedMsg','7aIjRzm','application',')::\x20','mp4','Message\x20Update\x20ok','logger','includes','closed','messageId','mediaType','split','chat:ack','ticket','public','425268veXngP','sendVideo','body','text','mediaName','18tiOrhS','messenger','.mp4','chat','fs/promises','2720030PmQMEN','sendImage','1238330tTrtNC','contact','__importDefault','audio','createdAt','mediaUrl','__esModule','\x20|\x20Ticket:\x20','toFormat','../../models/Message','../../utils/logger','2920638FgzpCF','toBuffer','Error\x20message\x20is\x20(tenant:\x20','info','sleepRandomTime','sharp','join','error','log','dataValues','ptt','../../models/Ticket','timestamp','2499662xzLWJG','fluent-ffmpeg','sendFile','image','2HIKzRS','update','sendAudio','../../helpers/socketEmit','872176oLZmnV','308025aNfQvb','../../utils/sleepRandomTime'];a=function(){return F;};return a();}Object[A(0x1ac)](exports,y(0x187),{'value':!![]});function b(c,d){const e=a();return b=function(f,g){f=f-0x171;let h=e[f];return h;},b(c,d);}const promises_1=require(y(0x17e)),fluent_ffmpeg_1=__importDefault(require(A(0x19a))),path_1=require('path'),sequelize_1=require(y(0x1a5)),sharp_1=__importDefault(require(y(0x191))),socketEmit_1=__importDefault(require(y(0x1a0))),Message_1=__importDefault(require(y(0x18a))),Ticket_1=__importDefault(require(y(0x197))),logger_1=require(A(0x18b)),sleepRandomTime_1=require(y(0x1a3)),MessengerSendMessagesSystem=async(c,d)=>{const B=A,C=A,e={'fromMe':!![],'messageId':{[sequelize_1['Op']['is']]:null},'status':B(0x1b0),[sequelize_1['Op']['or']]:[{'scheduleDate':{[sequelize_1['Op'][B(0x1a6)]]:new Date()}},{'scheduleDate':{[sequelize_1['Op']['is']]:null}}]},f=await Message_1[C(0x1af)][C(0x1a8)]({'where':e,'include':['contact',{'model':Ticket_1[C(0x1af)],'as':'ticket','where':{'tenantId':d,[sequelize_1['Op']['or']]:{'status':{[sequelize_1['Op']['ne']]:B(0x1b9)},'isFarewellMessage':!![]},'channel':B(0x17b),'whatsappId':c['id']},'include':['contact']},{'model':Message_1[C(0x1af)],'as':B(0x1b1),'include':[B(0x182)]}],'order':[[C(0x185),'ASC']]});let g;for(const h of f){const i=h,{ticket:j}=i,k=j[C(0x182)][B(0x1ab)];try{if(![B(0x17d),B(0x178)][C(0x1b8)](i['mediaType'])&&i[C(0x179)]){const m=(0x0,path_1[B(0x192)])(__dirname,'..','..','..',C(0x174)),n=(0x0,path_1['join'])(m,i[C(0x179)]),o=await(0x0,promises_1[B(0x1aa)])(n);console[B(0x194)](n);if(i[C(0x1bb)]===B(0x184)||i[B(0x1bb)]===B(0x196)){const p=i['mediaName'][B(0x171)]('.'),q=(0x0,path_1['join'])(m,p[0x0]+B(0x17c));await new Promise((s,t)=>{const D=C,E=B;(0x0,fluent_ffmpeg_1[D(0x1af)])(n)[E(0x189)](D(0x1b5))['on'](E(0x193),u=>t(u))['on'](D(0x1a7),()=>s(!![]))[E(0x1a4)](q);});const r=await(0x0,promises_1[C(0x1aa)])(q);g=await c[B(0x19f)](k,r);}if(i['mediaType']===B(0x19c)){const s=await(0x0,sharp_1['default'])(o)['jpeg']()[C(0x18d)]();g=await c[B(0x180)](k,s,{'filename':i[C(0x179)]});}i[B(0x1bb)]==='video'&&(g=await c[C(0x176)](k,o,{'filename':i[B(0x179)]})),[B(0x1b3),'file',B(0x1ad)]['includes'](i[C(0x1bb)])&&(g=await c[B(0x19b)](k,o,{'filename':i['mediaName']}));}[B(0x17d),C(0x178)][B(0x1b8)](i[C(0x1bb)])&&!i[C(0x179)]&&(g=await c['sendText'](k,i[C(0x177)]));const l={...i,...g,'id':i['id'],'timestamp':i['timestamp'],'messageId':g['messageId'],'status':B(0x1a9),'ack':0x2};await Message_1[C(0x1af)][B(0x19e)]({...l},{'where':{'id':i['id']}}),(0x0,socketEmit_1['default'])({'tenantId':j['tenantId'],'type':B(0x172),'payload':{...i[B(0x195)],'mediaUrl':i[B(0x186)],'id':i['id'],'timestamp':i[C(0x198)],'messageId':g[C(0x1ba)],'status':B(0x1a9),'ack':0x2}}),logger_1['logger'][C(0x18f)](C(0x1b6)),await(0x0,sleepRandomTime_1[B(0x190)])({'minMilliseconds':Number(0x1f4),'maxMilliseconds':Number(0x5dc)});}catch(t){const u=i['id'],v=i[B(0x173)]['id'];logger_1['logger'][C(0x193)](B(0x18e)+d+C(0x188)+v+')'),logger_1[C(0x1b7)]['error']('Error\x20send\x20message\x20(id:\x20'+u+B(0x1b4)+t);}}};exports[A(0x1af)]=MessengerSendMessagesSystem;