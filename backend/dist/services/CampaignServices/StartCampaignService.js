'use strict';function b(c,d){const e=a();return b=function(f,g){f=f-0x122;let h=e[f];return h;},b(c,d);}const I=b,J=b;(function(c,d){const G=b,H=b,e=c();while(!![]){try{const f=-parseInt(G(0x133))/0x1*(-parseInt(H(0x13c))/0x2)+parseInt(G(0x13b))/0x3+parseInt(G(0x131))/0x4*(-parseInt(H(0x153))/0x5)+parseInt(H(0x124))/0x6+-parseInt(H(0x159))/0x7*(-parseInt(H(0x134))/0x8)+parseInt(G(0x143))/0x9+parseInt(H(0x13a))/0xa*(-parseInt(G(0x122))/0xb);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x23191));function a(){const V=['map','length','start','../../libs/Queue','../../errors/AppError','10OraUHq','715089pDccje','86NDKgYQ','isAfter','split','../../models/Campaign','KZuiX','HH:mm','random','2559600TPubBl','WZlNl','mediaUrl','delay','addSeconds','SendMessageWhatsappCampaign','America/Sao_Paulo','update','__esModule','getMinutes','setMinutes','_contact_','session','contact','getTime','addDays','19055SAGAFL','20:00','_id_','findAll','campaginId_','setHours','34468qTceDU','ERR_CAMPAIGN_CONTACTS_NOT_EXISTS','parse','findOne','8319949XGiibL','date-fns','1367688rNbhjv','add','message2','date-fns-tz','sessionId','scheduled','message3','mFycD','isBefore','number','default','ifLUo','ERROR_CAMPAIGN_NOT_EXISTS','72vrmHrH','08:00','833uXBjFu','296vYDEac'];a=function(){return V;};return a();}var __importDefault=this&&this['__importDefault']||function(c){return c&&c['__esModule']?c:{'default':c};};Object['defineProperty'](exports,I(0x14b),{'value':!![]});const date_fns_1=require(J(0x123)),date_fns_tz_1=require(I(0x127)),Campaign_1=__importDefault(require(I(0x13f))),AppError_1=__importDefault(require(I(0x139))),CampaignContacts_1=__importDefault(require('../../models/CampaignContacts')),Queue_1=__importDefault(require(J(0x138))),cArquivoName=c=>{const K=I,L=I;if(!c)return'';const d=c[K(0x13e)]('/'),e=d[d[L(0x136)]-0x1];return e;},randomInteger=(c,d)=>{const M=J;return Math['floor'](Math[M(0x142)]()*(d-c+0x1))+c;},mountMessageData=(c,d,e)=>{const N=J,O=I,f=randomInteger(0x1,0x3);let g='';if(f===0x1)g=c['message1'];if(f===0x2)g=c[N(0x126)];if(f===0x3)g=c[N(0x12a)];return{'whatsappId':c[N(0x128)],'message':g,'number':d[N(0x150)][N(0x12d)],'mediaUrl':c[O(0x145)],'mediaName':cArquivoName(c[O(0x145)]),'messageRandom':'message'+f,'campaignContact':d,'options':e};},nextDayHoursValid=c=>{const P=J,Q=J;let d=c;const e=new Date(),f=(0x0,date_fns_1['differenceInDays'])(d,new Date());f<0x0&&(d=(0x0,date_fns_1[P(0x152)])(d,f*-0x1));if(d['getTime']()<e['getTime']()){if(Q(0x12f)==='ifLUo')d=(0x0,date_fns_1[P(0x14d)])((0x0,date_fns_1[Q(0x158)])(d,e['getHours']()),e[Q(0x14c)]());else return r=(0x0,s['addSeconds'])(t,u/0x3e8),v(w,x,{...y,'jobId':'campaginId_'+z['id']+P(0x14e)+A['contactId']+P(0x155)+B['id']+'_time_'+C[P(0x137)][Q(0x151)](),'delay':D(E,F)});}const g=(0x0,date_fns_1[Q(0x15b)])(P(0x132),Q(0x141),d),h=(0x0,date_fns_1[P(0x15b)])(P(0x154),P(0x141),d),i=(0x0,date_fns_1['isWithinInterval'])(d,{'start':g,'end':h}),j=(0x0,date_fns_1[P(0x12c)])(g,d),k=(0x0,date_fns_1[P(0x13d)])(h,d);!i&&j&&(d=(0x0,date_fns_1[Q(0x14d)])((0x0,date_fns_1[P(0x158)])(d,0x8),0x1e));if(!i&&k&&f===0x0){if(Q(0x140)===Q(0x144)){const n=(0x0,g['differenceInSeconds'])(h,new i());return n*0x3e8+j;}else d=(0x0,date_fns_1[P(0x152)])((0x0,date_fns_1['setHours'])(d,0x8),0x1);}return!i&&k&&f>0x0&&(d=(0x0,date_fns_1[Q(0x158)])(d,0x8)),d;},calcDelay=(c,d)=>{const e=(0x0,date_fns_1['differenceInSeconds'])(c,new Date());return e*0x3e8+d;},StartCampaignService=async({campaignId:c,tenantId:d,options:e})=>{const R=I,S=J,f=await Campaign_1[R(0x12e)][S(0x15c)]({'where':{'id':c,'tenantId':d},'include':[S(0x14f)]});if(!f){if(S(0x12b)!==R(0x12b))throw new d['default'](S(0x130),0x194);else throw new AppError_1[(S(0x12e))](S(0x130),0x194);}const g=await CampaignContacts_1[S(0x12e)][S(0x156)]({'where':{'campaignId':c},'include':['contact']});if(!g)throw new AppError_1[(S(0x12e))](S(0x15a),0x194);const h=f[R(0x146)]?f[S(0x146)]*0x3e8:0x4e20;let i=(0x0,date_fns_tz_1['zonedTimeToUtc'])(f[R(0x137)],S(0x149));const j=g[S(0x135)](l=>{const T=S,U=S;return i=(0x0,date_fns_1[T(0x147)])(i,h/0x3e8),mountMessageData(f,l,{...e,'jobId':U(0x157)+f['id']+'_contact_'+l['contactId']+U(0x155)+l['id']+'_time_'+f[U(0x137)][U(0x151)](),'delay':calcDelay(i,h)});});Queue_1[S(0x12e)][R(0x125)](R(0x148),j),await f[S(0x14a)]({'status':S(0x129)});};exports[J(0x12e)]=StartCampaignService;