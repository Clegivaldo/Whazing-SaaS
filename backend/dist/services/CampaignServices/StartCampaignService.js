'use strict';function a(){const X=['61336cahEaX','contact','random','map','setHours','186515EcRhgL','message1','isAfter','30634dKITpU','73007YYVgKh','getHours','39KnltCI','default','../../errors/AppError','385014MEOzJM','message','session','add','differenceInSeconds','delay','findAll','isWithinInterval','setMinutes','scheduled','getMinutes','_time_','xVTki','24leQaey','defineProperty','__esModule','parse','HH:mm','number','addDays','44iUlgnt','date-fns','_contact_','ERR_CAMPAIGN_CONTACTS_NOT_EXISTS','423twVNYt','20:00','message2','ERROR_CAMPAIGN_NOT_EXISTS','315342SRBHfW','TfOkj','isBefore','511obqncK','_id_','mediaUrl','America/Sao_Paulo','__importDefault','addSeconds','138440ozFArA','../../models/Campaign','length','campaginId_','floor','../../models/CampaignContacts','date-fns-tz','zonedTimeToUtc','getTime','../../libs/Queue','sessionId','update','message3'];a=function(){return X;};return a();}const I=b,K=b;function b(c,d){const e=a();return b=function(f,g){f=f-0xd8;let h=e[f];return h;},b(c,d);}(function(c,d){const G=b,H=b,e=c();while(!![]){try{const f=-parseInt(G(0x102))/0x1*(parseInt(G(0xff))/0x2)+parseInt(H(0xe1))/0x3+parseInt(G(0xd9))/0x4*(-parseInt(H(0xfc))/0x5)+parseInt(H(0x105))/0x6+parseInt(H(0xe4))/0x7*(parseInt(H(0xf7))/0x8)+parseInt(H(0xdd))/0x9*(parseInt(H(0xea))/0xa)+-parseInt(H(0x100))/0xb*(-parseInt(G(0x112))/0xc);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x5e0c4));var __importDefault=this&&this[I(0xe8)]||function(c){const J=I;return c&&c[J(0x114)]?c:{'default':c};};Object[I(0x113)](exports,K(0x114),{'value':!![]});const date_fns_1=require(I(0xda)),date_fns_tz_1=require(I(0xf0)),Campaign_1=__importDefault(require(K(0xeb))),AppError_1=__importDefault(require(I(0x104))),CampaignContacts_1=__importDefault(require(I(0xef))),Queue_1=__importDefault(require(I(0xf3))),cArquivoName=c=>{const L=I;if(!c)return'';const d=c['split']('/'),e=d[d[L(0xec)]-0x1];return e;},randomInteger=(c,d)=>{const M=K,N=K;return Math[M(0xee)](Math[M(0xf9)]()*(d-c+0x1))+c;},mountMessageData=(c,d,e)=>{const O=I,P=K,f=randomInteger(0x1,0x3);let g='';if(f===0x1)g=c[O(0xfd)];if(f===0x2)g=c[O(0xdf)];if(f===0x3)g=c[P(0xf6)];return{'whatsappId':c[O(0xf4)],'message':g,'number':d[O(0xf8)][P(0x117)],'mediaUrl':c[O(0xe6)],'mediaName':cArquivoName(c[P(0xe6)]),'messageRandom':P(0x106)+f,'campaignContact':d,'options':e};},nextDayHoursValid=c=>{const Q=I,R=I;let d=c;const e=new Date(),f=(0x0,date_fns_1['differenceInDays'])(d,new Date());f<0x0&&(d=(0x0,date_fns_1['addDays'])(d,f*-0x1));d[Q(0xf2)]()<e['getTime']()&&('NJcte'!==Q(0xe2)?d=(0x0,date_fns_1['setMinutes'])((0x0,date_fns_1[R(0xfb)])(d,e[Q(0x101)]()),e[Q(0x10f)]()):g=(0x0,h[Q(0xd8)])(i,j*-0x1));const g=(0x0,date_fns_1[Q(0x115)])('08:00',Q(0x116),d),h=(0x0,date_fns_1[Q(0x115)])(R(0xde),R(0x116),d),i=(0x0,date_fns_1[R(0x10c)])(d,{'start':g,'end':h}),j=(0x0,date_fns_1[R(0xe3)])(g,d),k=(0x0,date_fns_1[R(0xfe)])(h,d);!i&&j&&(d=(0x0,date_fns_1[Q(0x10d)])((0x0,date_fns_1['setHours'])(d,0x8),0x1e));!i&&k&&f===0x0&&(d=(0x0,date_fns_1['addDays'])((0x0,date_fns_1['setHours'])(d,0x8),0x1));if(!i&&k&&f>0x0){if(Q(0x111)!=='xVTki'){const n=(0x0,g[Q(0x109)])(h,new i());return n*0x3e8+j;}else d=(0x0,date_fns_1[R(0xfb)])(d,0x8);}return d;},calcDelay=(c,d)=>{const S=K,e=(0x0,date_fns_1[S(0x109)])(c,new Date());return e*0x3e8+d;},StartCampaignService=async({campaignId:c,tenantId:d,options:e})=>{const T=K,U=K,f=await Campaign_1[T(0x103)]['findOne']({'where':{'id':c,'tenantId':d},'include':[T(0x107)]});if(!f)throw new AppError_1[(U(0x103))](U(0xe0),0x194);const g=await CampaignContacts_1[T(0x103)][T(0x10b)]({'where':{'campaignId':c},'include':['contact']});if(!g)throw new AppError_1[(U(0x103))](T(0xdc),0x194);const h=f[T(0x10a)]?f['delay']*0x3e8:0x4e20;let i=(0x0,date_fns_tz_1[U(0xf1)])(f['start'],T(0xe7));const j=g[T(0xfa)](k=>{const V=U,W=U;return i=(0x0,date_fns_1[V(0xe9)])(i,h/0x3e8),mountMessageData(f,k,{...e,'jobId':W(0xed)+f['id']+W(0xdb)+k['contactId']+V(0xe5)+k['id']+V(0x110)+f['start'][W(0xf2)](),'delay':calcDelay(i,h)});});Queue_1[U(0x103)][T(0x108)]('SendMessageWhatsappCampaign',j),await f[T(0xf5)]({'status':U(0x10e)});};exports[I(0x103)]=StartCampaignService;